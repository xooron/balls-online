<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balls Pro PvP</title>
    <style>
        :root {
            --bg: #05050a;
            --blue: #00d2ff;
            --green: #00ff88;
            --surface: #0f0f1b;
            --user-color: #00ffff;
        }

        body {
            margin: 0; background: #000; color: white;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex; justify-content: center; overflow: hidden;
        }

        .app {
            width: 100%; max-width: 400px; height: 100vh;
            background: var(--bg); display: flex; flex-direction: column;
            position: relative;
        }

        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        
        /* –ö–Ω–æ–ø–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; font-size: 20px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .history-btn:active { transform: scale(0.9); background: var(--blue); }

        .balance {
            background: rgba(255,255,255,0.05); padding: 8px 16px;
            border-radius: 20px; font-weight: 900; border: 1px solid var(--blue);
            cursor: pointer; font-size: 16px;
        }

        .jackpot-card {
            margin: 0 15px 10px; padding: 15px; border-radius: 20px;
            background: linear-gradient(135deg, #0a0a25 0%, #05050a 100%);
            border: 1px solid rgba(0, 210, 255, 0.2);
            text-align: center; flex-shrink: 0;
        }
        .jackpot-val { font-size: 32px; font-weight: 900; }

        .game-viewport {
            width: 340px; height: 340px; margin: 0 auto;
            position: relative; border-radius: 35px; 
            overflow: hidden; border: 6px solid #1a1a2e;
            flex-shrink: 0; background: #000;
        }

        .status-line { text-align: center; margin: 10px 0; font-size: 11px; color: #555; letter-spacing: 1px; }

        .bet-panel { padding: 10px 15px; flex-shrink: 0; }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .chip {
            background: #111122; border: 2px solid transparent; padding: 12px 0;
            border-radius: 12px; color: white; font-weight: bold; cursor: pointer;
        }
        .chip.active { border-color: var(--blue); background: rgba(0,210,255,0.1); }
        .bet-btn {
            width: 100%; padding: 18px; border-radius: 15px;
            background: var(--green); border: none; color: #000;
            font-weight: 900; font-size: 18px; cursor: pointer;
        }

        /* –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ */
        .players-list { flex-grow: 1; overflow-y: auto; padding: 5px 20px; background: rgba(0,0,0,0.4); }
        .p-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #161625; font-size: 14px; }

        /* –û–≤–µ—Ä–ª–µ–∏ (–ü–æ–±–µ–¥–∞ –∏ –ò—Å—Ç–æ—Ä–∏—è) */
        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.96);
            display: none; flex-direction: column; justify-content: center;
            align-items: center; z-index: 1000; text-align: center;
        }
        .history-overlay { justify-content: flex-start; padding-top: 50px; }
        
        .w-avatar { width: 90px; height: 90px; border-radius: 50%; border: 4px solid var(--green); margin-bottom: 15px; }
        
        /* –≠–ª–µ–º–µ–Ω—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-list { width: 90%; max-height: 70vh; overflow-y: auto; margin-top: 20px; }
        .history-item {
            display: flex; align-items: center; background: #111; 
            margin-bottom: 10px; padding: 10px; border-radius: 12px;
            border-left: 4px solid var(--blue);
        }
        .hist-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; }
        .hist-info { flex-grow: 1; text-align: left; }
        .hist-x { color: var(--green); font-weight: 900; margin-left: 10px; }
    </style>
</head>
<body>

<div class="app">
    <div class="header">
        <div class="history-btn" onclick="toggleHistory(true)">üïí</div>
        <div class="balance" id="topup">üíé <span id="bal-val">100.0</span></div>
    </div>

    <div class="jackpot-card">
        <div style="font-size:11px; color:var(--blue); margin-bottom:4px">JACKPOT</div>
        <div class="jackpot-val"><span id="bank-val">0.00</span> <small style="font-size:14px; opacity:0.5">TON</small></div>
    </div>

    <div class="status-line" id="status-text">–û–ñ–ò–î–ê–ù–ò–ï –°–¢–ê–í–û–ö... <span id="timer">15</span>–°</div>

    <div class="game-viewport">
        <canvas id="gameCanvas" width="340" height="340"></canvas>
        
        <!-- –û–∫–Ω–æ –ø–æ–±–µ–¥—ã -->
        <div id="win-overlay" class="overlay">
            <img src="" id="win-img" class="w-avatar">
            <h2 id="win-name" style="margin:0">NAME</h2>
            <h1 id="win-sum" style="color:var(--blue); margin:5px 0">+0.00 TON</h1>
            <div style="background:var(--green); color:#000; padding:4px 12px; border-radius:8px; font-weight:900;" id="win-x">x0.00</div>
            <button onclick="resetGame()" style="margin-top:25px; padding:14px 45px; border-radius:12px; border:none; background:var(--blue); color:white; font-weight:bold; cursor:pointer;">–î–ê–õ–ï–ï</button>
        </div>

        <!-- –û–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ -->
        <div id="history-overlay" class="overlay history-overlay">
            <h2>–ò–°–¢–û–†–ò–Ø –ò–ì–†</h2>
            <div class="history-list" id="hist-content">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –∑–∞–ø–∏—Å–∏ -->
            </div>
            <button onclick="toggleHistory(false)" style="margin-top:20px; padding:10px 30px; border-radius:10px; border:none; background:#333; color:white;">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <div class="bet-panel">
        <div class="chips">
            <button class="chip" onclick="selectChip(10)">10</button>
            <button class="chip" onclick="selectChip(50)">50</button>
            <button class="chip" onclick="selectChip(100)">100</button>
            <button class="chip" onclick="selectChip(500)">500</button>
        </div>
        <button class="bet-btn" id="bet-confirm" onclick="confirmBet()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –°–¢–ê–í–ö–£</button>
    </div>

    <div class="players-list" id="p-list"></div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    let balance = 1000.0, selAmt = 0, bank = 0, players = [], history = [], state = 'BETTING', timeLeft = 15;
    let timerInt, botInt;

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞–ª–µ–Ω—å–∫–æ–≥–æ –∫—Ä—É–≥–ª–æ–≥–æ —à–∞—Ä–∏–∫–∞
    let ball = { x: 170, y: 170, r: 8, vx: 0, vy: 0, arrowA: 0 };
    let startTime = 0;

    const botNames = ['@Whale', '@Degen', '@TopTrader', '@Bull', '@Moby', '@Elon', '@Sniper', '@Lucky', '@Alpha', '@Turbo'];
    const botColors = ['#5a3d8c', '#8c3d3d', '#3d8c5a', '#8c7a3d', '#3d7a8c', '#555555', '#4a2a2a', '#2a4a2a'];
    
    document.getElementById('topup').onclick = () => { balance += 500; updateUI(); };

    function selectChip(amt) {
        if(state !== 'BETTING') return;
        selAmt = amt;
        document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', parseInt(c.innerText) === amt));
    }

    function confirmBet() {
        if(selAmt <= 0 || balance < selAmt || state !== 'BETTING') return;
        balance -= selAmt;
        addPlayer('–í—ã (–ò–≥—Ä–æ–∫)', selAmt, 'https://i.pravatar.cc/100?u=me', true);
        selAmt = 0;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        updateUI();
    }

    function addPlayer(name, amt, avatarUrl, isUser = false) {
        let p = players.find(x => x.name === name);
        if (p) { p.bet += amt; } 
        else {
            // –¢–≤–æ–π —Ü–≤–µ—Ç ‚Äî —è—Ä–∫–æ-–±–∏—Ä—é–∑–æ–≤—ã–π, —É –±–æ—Ç–æ–≤ ‚Äî –±–æ–ª–µ–µ —Ç—É—Å–∫–ª—ã–µ
            const color = isUser ? '#00ffff' : botColors[players.length % botColors.length];
            const img = new Image(); img.src = avatarUrl;
            players.push({ name, bet: amt, color, avatar: img, isUser, startA: 0, endA: 0 });
        }
        bank += amt;
        updateUI();
    }

    function updateUI() {
        document.getElementById('bal-val').innerText = balance.toFixed(1);
        document.getElementById('bank-val').innerText = bank.toFixed(2);
        const list = document.getElementById('p-list');
        list.innerHTML = '';
        players.sort((a,b) => b.bet - a.bet).forEach(p => {
            list.innerHTML += `<div class="p-item"><span><b style="color:${p.color}">‚óè</b> ${p.name}</span><b>${p.bet.toFixed(1)} TON</b></div>`;
        });
        document.getElementById('bet-confirm').disabled = (state !== 'BETTING');
    }

    function toggleHistory(show) {
        document.getElementById('history-overlay').style.display = show ? 'flex' : 'none';
        if(show) renderHistory();
    }

    function renderHistory() {
        const cont = document.getElementById('hist-content');
        cont.innerHTML = history.length === 0 ? '<p style="opacity:0.5">–ò—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç</p>' : '';
        history.forEach(h => {
            cont.innerHTML += `
                <div class="history-item">
                    <img src="${h.avatar}" class="hist-avatar">
                    <div class="hist-info">
                        <div style="font-size:14px; font-weight:bold">${h.name}</div>
                        <div style="font-size:12px; opacity:0.6">+${h.prize} TON</div>
                    </div>
                    <div class="hist-x">x${h.x}</div>
                </div>
            `;
        });
    }

    function initBots() {
        const count = Math.floor(Math.random() * 5) + 6;
        let pool = botNames.sort(() => 0.5 - Math.random()).slice(0, count);
        botInt = setInterval(() => {
            if (state === 'BETTING' && pool.length > 0) {
                const name = pool.pop();
                const bet = parseFloat((Math.random() * 49 + 1).toFixed(1));
                addPlayer(name, bet, `https://i.pravatar.cc/100?u=${name}`);
            }
        }, 1500);
    }

    function startTimer() {
        timerInt = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timerInt); clearInterval(botInt);
                if (players.length === 0) return resetGame();
                state = 'ARROW'; startTime = Date.now();
            }
        }, 1000);
    }

    function draw() {
        ctx.clearRect(0, 0, 340, 340);
        if (bank > 0) {
            let currentA = 0;
            players.forEach(p => {
                const slice = (p.bet / bank) * (Math.PI * 2);
                p.startA = currentA;
                p.endA = currentA + slice;

                ctx.beginPath();
                ctx.moveTo(170, 170);
                ctx.arc(170, 170, 600, p.startA, p.endA);
                ctx.fillStyle = p.color;
                
                // –ï—Å–ª–∏ —ç—Ç–æ —Ç—ã, –¥–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ç–æ—Ä–∞
                if(p.isUser) {
                    ctx.globalAlpha = 1.0;
                    ctx.shadowBlur = 30; ctx.shadowColor = p.color;
                } else {
                    ctx.globalAlpha = 0.7;
                    ctx.shadowBlur = 0;
                }
                
                ctx.fill();
                ctx.shadowBlur = 0; ctx.globalAlpha = 1.0;

                // –ê–≤–∞—Ç–∞—Ä–∫–∏
                const midA = p.startA + slice/2;
                const ax = 170 + Math.cos(midA) * 100;
                const ay = 170 + Math.sin(midA) * 100;
                ctx.save();
                ctx.beginPath(); ctx.arc(ax, ay, 18, 0, Math.PI*2); ctx.clip();
                if(p.avatar.complete) ctx.drawImage(p.avatar, ax-18, ay-18, 36, 36);
                ctx.restore();
                ctx.strokeStyle = 'white'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(ax, ay, 18, 0, Math.PI*2); ctx.stroke();
                currentA += slice;
            });
        }

        if (state === 'ARROW') {
            ball.arrowA += 0.25;
            drawBall(170, 170);
            drawArrow(170, 170, ball.arrowA);
            if (Date.now() - startTime > 2000) {
                state = 'FLYING'; startTime = Date.now();
                ball.vx = Math.cos(ball.arrowA) * 32;
                ball.vy = Math.sin(ball.arrowA) * 32;
            }
        } 
        else if (state === 'FLYING') {
            ball.x += ball.vx; ball.y += ball.vy;
            if (ball.x < 10 || ball.x > 330) ball.vx *= -1;
            if (ball.y < 10 || ball.y > 330) ball.vy *= -1;
            ball.vx *= 0.9958; ball.vy *= 0.9958;
            drawBall(ball.x, ball.y);
            if (Date.now() - startTime > 20000 || (Math.abs(ball.vx) < 0.05 && Math.abs(ball.vy) < 0.05)) finish();
        }
        else { drawBall(state === 'END' ? ball.x : 170, state === 'END' ? ball.y : 170); }
        requestAnimationFrame(draw);
    }

    function drawBall(x, y) {
        ctx.beginPath(); ctx.arc(x, y, ball.r, 0, Math.PI*2);
        ctx.fillStyle = 'white'; ctx.shadowBlur = 15; ctx.shadowColor = 'white';
        ctx.fill(); ctx.shadowBlur = 0;
    }

    function drawArrow(x, y, ang) {
        ctx.save(); ctx.translate(x, y); ctx.rotate(ang);
        ctx.beginPath(); ctx.moveTo(20, 0); ctx.lineTo(60, 0);
        ctx.strokeStyle = 'white'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.stroke();
        ctx.restore();
    }

    function finish() {
        state = 'END';
        let angle = Math.atan2(ball.y - 170, ball.x - 170);
        if (angle < 0) angle += Math.PI * 2;
        let winner = players.find(p => angle >= p.startA && angle <= p.endA) || players[0];
        let xMult = (bank / winner.bet).toFixed(2);

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        history.unshift({ name: winner.name, avatar: winner.avatar.src, x: xMult, prize: bank.toFixed(2) });
        if(history.length > 20) history.pop();

        document.getElementById('win-overlay').style.display = 'flex';
        document.getElementById('win-img').src = winner.avatar.src;
        document.getElementById('win-name').innerText = winner.name;
        document.getElementById('win-name').style.color = winner.color;
        document.getElementById('win-sum').innerText = `+${bank.toFixed(2)} TON`;
        document.getElementById('win-x').innerText = `x${xMult}`;

        if (winner.isUser) { balance += bank; updateUI(); }
    }

    function resetGame() {
        bank = 0; players = []; timeLeft = 15; state = 'BETTING';
        ball = { x: 170, y: 170, r: 8, vx: 0, vy: 0, arrowA: Math.random()*10 };
        document.getElementById('win-overlay').style.display = 'none';
        document.getElementById('status-text').innerHTML = '–û–ñ–ò–î–ê–ù–ò–ï –°–¢–ê–í–û–ö... <span id="timer">15</span>–°';
        updateUI(); initBots(); startTimer();
    }

    initBots(); startTimer(); draw();
</script>
</body>
</html>
