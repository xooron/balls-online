<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ICE ARENA PvP</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { 
            --bg: #030816; 
            --accent: #00f2fe; 
            --frost: rgba(255, 255, 255, 0.08); 
        }
        
        body { 
            margin: 0; background: var(--bg); color: white; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            overflow-x: hidden; overflow-y: auto;
            min-height: 100vh;
        }

        .snow-wrapper { position: fixed; inset: 0; pointer-events: none; z-index: 0; background: radial-gradient(circle at 50% -20%, #1e3a5f 0%, #030816 70%); }
        .snowflake { position: absolute; top: -10px; color: white; animation: fall linear infinite; opacity: 0.6; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }

        .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; background: rgba(3,8,22,0.8); backdrop-filter: blur(10px); }
        .logo-area { display: flex; flex-direction: column; cursor: pointer; }
        .logo-text { font-size: 22px; font-weight: 900; color: white; text-shadow: 0 0 15px var(--accent); letter-spacing: 1px; }
        .online-count { font-size: 10px; color: var(--accent); font-weight: bold; margin-top: 2px; }

        .balance-pill { 
            background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 30px; 
            border: 1px solid var(--accent); font-weight: 900; box-shadow: 0 0 15px rgba(0, 242, 254, 0.3);
        }

        /* –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –°–¢–†–ê–ù–ò–¶ */
        .page { display: none; padding-bottom: 120px; position: relative; z-index: 5; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .arena-container { display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        .bank-label { font-size: 11px; color: var(--accent); letter-spacing: 2px; font-weight: bold; }
        .bank-value { font-size: 36px; font-weight: 900; margin-bottom: 15px; }

        .canvas-wrapper { 
            position: relative; width: 320px; height: 320px; 
            border: 4px solid #fff; border-radius: 20px; overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.8), 0 0 20px var(--accent);
        }
        #gameCanvas { width: 320px; height: 320px; display: block; }

        .bet-panel { padding: 20px; background: var(--frost); margin: 0 15px; border-radius: 25px; backdrop-filter: blur(10px); }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .chip { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); padding: 12px 0; border-radius: 12px; color: #fff; font-weight: bold; text-align: center; }
        .chip.active { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent); }
        
        .main-btn { 
            width: 100%; padding: 18px; border-radius: 20px; border: none; font-weight: 900; 
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%); color: #030816; font-size: 18px;
        }

        .leaderboard-card { margin: 20px 15px; padding: 20px; background: var(--frost); border-radius: 25px; }
        .leader-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .navbar { position: fixed; bottom: 0; width: 100%; height: 75px; background: rgba(3, 8, 22, 0.95); display: flex; border-top: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(15px); z-index: 1000; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: #555; cursor: pointer; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }

        /* –ê–î–ú–ò–ù –ú–û–î–ê–õ–ö–ê */
        .admin-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 2000; display: none; flex-direction: column; padding: 60px 20px; }
        #win-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    </style>
</head>
<body>

<div class="snow-wrapper" id="snow"></div>

<!-- –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ -->
<div id="admin-panel" class="admin-modal">
    <h1 style="color:var(--accent); text-align:center">ICE ADMIN</h1>
    <p style="text-align:center; opacity:0.6">–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω: @maesexs</p>
    <button class="main-btn" style="background:#ff4757; color:white; margin-bottom:15px" onclick="adminCmd('bet_500k')">üî• –°–¢–ê–í–ö–ê 500,000 TON</button>
    <button class="main-btn" style="background:gold; margin-bottom:15px" onclick="adminCmd('gift_all')">üéÅ –ü–û–î–ê–†–ò–¢–¨ –í–°–ï–ú 10,000</button>
    <button class="main-btn" style="background:var(--accent); margin-bottom:15px" onclick="adminCmd('bot')">ü§ñ –î–û–ë–ê–í–ò–¢–¨ –ë–û–¢–ê</button>
    <button class="main-btn" style="background:#333; color:white" onclick="toggleAdmin(false)">–ó–ê–ö–†–´–¢–¨ –ü–ê–ù–ï–õ–¨</button>
</div>

<div class="header">
    <div class="logo-area" onclick="checkAdmin()">
        <span class="logo-text">ICE ARENA</span>
        <span class="online-count">‚óè <span id="online-val">0</span> –û–ù–õ–ê–ô–ù</span>
    </div>
    <div class="balance-pill">‚ùÑÔ∏è <span id="bal-val">0</span></div>
</div>

<!-- –°–¢–†–ê–ù–ò–¶–ê –ê–†–ï–ù–´ -->
<div id="page-arena" class="page active">
    <div class="arena-container">
        <span class="bank-label">–û–ë–©–ò–ô –ë–ê–ù–ö</span>
        <div class="bank-value"><span id="bank-val">0</span> <span style="font-size: 18px; color: var(--accent);">TON</span></div>
        <div class="canvas-wrapper">
            <canvas id="gameCanvas"></canvas>
            <div id="win-overlay">
                <img id="win-img" src="" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--accent);">
                <h2 id="win-name" style="margin: 15px 0 5px 0;"></h2>
                <h1 id="win-sum" style="color:var(--accent); margin:0;"></h1>
            </div>
        </div>
        <div id="status-text" style="margin: 15px 0; font-size: 12px; font-weight: bold; color: var(--accent); letter-spacing: 1px;">–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í...</div>
    </div>

    <div class="bet-panel">
        <div class="chips">
            <div class="chip active" onclick="setBet(1000, this)">1–ö</div>
            <div class="chip" onclick="setBet(5000, this)">5–ö</div>
            <div class="chip" onclick="setBet(10000, this)">10–ö</div>
            <div class="chip" onclick="setBet(50000, this)">50–ö</div>
        </div>
        <button class="main-btn" onclick="confirmBet()">–°–î–ï–õ–ê–¢–¨ –°–¢–ê–í–ö–£</button>
    </div>

    <div class="leaderboard-card">
        <h3 style="margin-top:0">üèÜ –¢–û–ü 10 –ò–ì–†–û–ö–û–í</h3>
        <div id="leader-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div id="players-list" style="padding: 20px;"></div>
</div>

<!-- –°–¢–†–ê–ù–ò–¶–ê –ü–†–û–§–ò–õ–Ø -->
<div id="page-profile" class="page">
    <div style="text-align: center; padding: 40px 20px;">
        <img id="u-pic" style="width:100px; height:100px; border-radius:50%; border:4px solid var(--accent); box-shadow: 0 0 20px var(--accent);" src="">
        <h2 id="u-name" style="margin: 15px 0 5px 0;">–ò–≥—Ä–æ–∫</h2>
        <p id="u-username" style="opacity: 0.5; margin-bottom: 20px;">@username</p>
        
        <div id="bonus-box" style="background: var(--frost); padding: 20px; border-radius: 20px;">
            <button class="main-btn" id="bonus-btn" onclick="takeBonus()">–ü–û–õ–£–ß–ò–¢–¨ 1000 ‚ùÑÔ∏è</button>
            <p id="bonus-timer" style="margin: 0; font-weight: bold; color: var(--accent);"></p>
        </div>
    </div>
    
    <div style="padding: 0 20px;">
        <h3>üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h3>
        <div id="hist-list"></div>
    </div>
</div>

<div class="navbar">
    <div class="nav-btn active" id="nav-arena" onclick="showTab('arena', this)">
        <svg viewBox="0 0 24 24"><path d="M21 16.5C21 16.88 20.79 17.21 20.47 17.38L12.57 21.82C12.41 21.94 12.21 22 12 22C11.79 22 11.59 21.94 11.43 21.82L3.53 17.38C3.21 17.21 3 16.88 3 16.5V7.5C3 7.12 3.21 6.79 3.53 6.62L11.43 2.18C11.59 2.06 11.79 2 12 2C12.21 2 12.41 2.06 12.57 2.18L20.47 6.62C20.79 6.79 21 7.12 21 7.5V16.5Z"/></svg>
        <span>–ê—Ä–µ–Ω–∞</span>
    </div>
    <div class="nav-btn" id="nav-profile" onclick="showTab('profile', this)">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
        <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ß–ï–¢–ö–û–ì–û –∫–∞—á–µ—Å—Ç–≤–∞
    const dpr = window.devicePixelRatio || 1;
    canvas.width = 320 * dpr;
    canvas.height = 320 * dpr;
    ctx.scale(dpr, dpr);

    // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const tgData = tg.initDataUnsafe?.user || { id: 777, first_name: "GUEST", username: "maesexs" };
    let user = { 
        uid: 'tg_'+tgData.id, 
        name: tgData.first_name, 
        avatar: tgData.photo_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${tgData.id}`, 
        username: tgData.username || "" 
    };

    // –ë–∞–ª–∞–Ω—Å –∏ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    if (!localStorage.getItem('init_v2')) {
        localStorage.setItem('bal_v6', 5000);
        localStorage.setItem('init_v2', 'true');
    }
    let balance = parseFloat(localStorage.getItem('bal_v6')) || 0;
    let history = JSON.parse(localStorage.getItem('hist_v6')) || [];
    let lastBonus = parseInt(localStorage.getItem('bonus_v6')) || 0;
    let selAmt = 1000;
    let srv = { players: [], status: 'WAITING', bank: 0, ball: {x:160, y:160} };
    let pImgs = {};

    // –°–Ω–µ–≥
    function createSnow() {
        const w = document.getElementById('snow');
        for(let i=0; i<40; i++) {
            let s = document.createElement('div');
            s.className = 'snowflake'; s.innerHTML = '‚ùÑ';
            s.style.left = Math.random() * 100 + 'vw';
            s.style.animationDuration = (Math.random() * 3 + 4) + 's';
            w.appendChild(s);
        }
    }
    createSnow();

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
    function showTab(tabName, el) {
        console.log("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞:", tabName);
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        const targetPage = document.getElementById('page-' + tabName);
        if (targetPage) targetPage.classList.add('active');
        if (el) el.classList.add('active');
        
        if (tabName === 'profile') updateProfile();
    }

    // –õ–∏–¥–µ—Ä–±–æ—Ä–¥
    setInterval(() => {
        socket.emit('update_balance', { ...user, balance: balance });
    }, 3000);

    socket.on('leaderboard_update', (list) => {
        const html = list.map((l, i) => `
            <div class="leader-row">
                <span>${i+1}. ${l.name}</span>
                <b style="color:var(--accent)">${Math.floor(l.balance)} ‚ùÑÔ∏è</b>
            </div>
        `).join('');
        document.getElementById('leader-list').innerHTML = html || "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç";
    });

    // –ê–¥–º–∏–Ω–∫–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
    function checkAdmin() {
        console.log("–ù–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", user.username);
        if (user.username.toLowerCase() === 'maesexs') {
            toggleAdmin(true);
        } else {
            tg.showAlert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í–∞—à –Ω–∏–∫: @" + (user.username || "–Ω–µ—Ç"));
        }
    }
    function toggleAdmin(show) {
        document.getElementById('admin-panel').style.display = show ? 'flex' : 'none';
    }
    function adminCmd(type) {
        socket.emit('admin_cmd', { ...user, type: type });
        if(type !== 'bot') toggleAdmin(false);
    }

    // –°—Ç–∞–≤–∫–∏
    function setBet(amount, el) { 
        selAmt = amount; 
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        if(el) el.classList.add('active');
    }

    function confirmBet() {
        if (balance < selAmt) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚ùÑÔ∏è");
        if (srv.status !== 'WAITING' && srv.status !== 'COUNTDOWN') return tg.showAlert("–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å!");
        
        balance -= selAmt;
        localStorage.setItem('bal_v6', balance);
        socket.emit('bet', { ...user, bet: selAmt });
        tg.HapticFeedback.impactOccurred('heavy');
        updateUI();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ü—Ä–æ—Ñ–∏–ª—è (–ò–°–ü–†–ê–í–õ–ï–ù–û)
    function updateProfile() {
        document.getElementById('u-pic').src = user.avatar;
        document.getElementById('u-name').innerText = user.name;
        document.getElementById('u-username').innerText = user.username ? "@" + user.username : "";
        
        const now = Date.now();
        const rem = 3600000 - (now - lastBonus);
        
        if(rem > 0) {
            document.getElementById('bonus-btn').style.display = 'none';
            const mins = Math.ceil(rem / 60000);
            document.getElementById('bonus-timer').innerText = `–ë–æ–Ω—É—Å —á–µ—Ä–µ–∑: ${mins} –º–∏–Ω`;
        } else {
            document.getElementById('bonus-btn').style.display = 'block';
            document.getElementById('bonus-timer').innerText = '';
        }

        const hList = history.length > 0 ? [...history].reverse().map(h => `
            <div style="display:flex; justify-content:space-between; padding:15px; background:rgba(255,255,255,0.03); border-radius:15px; margin-bottom:10px">
                <span style="color:${h.win?'#00ff88':'#ff4757'}; font-weight:bold">${h.win?'–í–´–ò–ì–†–´–®':'–ü–†–û–ò–ì–†–´–®'}</span>
                <span>${Math.floor(h.amt)} TON</span>
            </div>
        `).join('') : "<p style='text-align:center; opacity:0.5'>–ò–≥—Ä –µ—â–µ –Ω–µ –±—ã–ª–æ</p>";
        
        document.getElementById('hist-list').innerHTML = hList;
    }

    function takeBonus() {
        balance += 1000;
        lastBonus = Date.now();
        localStorage.setItem('bal_v6', balance);
        localStorage.setItem('bonus_v6', lastBonus);
        updateProfile();
        updateUI();
        tg.showAlert("–í—ã –ø–æ–ª—É—á–∏–ª–∏ 1000 ‚ùÑÔ∏è!");
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    socket.on('sync', (data) => {
        const oldStatus = srv.status;
        srv = data;
        if (oldStatus !== 'WINNER' && srv.status === 'WINNER') {
            const isMe = srv.winner?.uid === user.uid;
            const myBet = srv.players.find(p => p.uid === user.uid);
            if (myBet) {
                if(isMe) { balance += srv.bank; tg.HapticFeedback.notificationOccurred('success'); }
                history.push({ win: isMe, amt: isMe ? srv.bank : myBet.bet, date: new Date().toLocaleTimeString() });
                localStorage.setItem('bal_v6', balance);
                localStorage.setItem('hist_v6', JSON.stringify(history.slice(-10)));
            }
        }
        updateUI();
        srv.players.forEach(p => { if(!pImgs[p.uid]) { const img = new Image(); img.src = p.avatar; pImgs[p.uid] = img; }});
    });

    function updateUI() {
        document.getElementById('bal-val').innerText = Math.floor(balance);
        document.getElementById('bank-val').innerText = Math.floor(srv.bank);
        document.getElementById('online-val').innerText = srv.online;
        
        const st = document.getElementById('status-text');
        if(srv.status === 'WAITING') st.innerText = "–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í (2+)";
        else if(srv.status === 'COUNTDOWN') st.innerText = `–°–¢–ê–†–¢ –ß–ï–†–ï–ó ${srv.timer} –°–ï–ö`;
        else st.innerText = "–®–ê–† –í –î–í–ò–ñ–ï–ù–ò–ò";

        document.getElementById('win-overlay').style.display = (srv.status === 'WINNER'?'flex':'none');
        if(srv.winner) {
            document.getElementById('win-img').src = srv.winner.avatar;
            document.getElementById('win-name').innerText = srv.winner.name;
            document.getElementById('win-sum').innerText = `+${Math.floor(srv.bank)} TON`;
        }
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ (–ö–∞–Ω–≤–∞—Å)
    function draw() {
        ctx.clearRect(0, 0, 320, 320);
        srv.players.forEach(p => {
            if(!p.rect) return;
            ctx.fillStyle = p.color; ctx.globalAlpha = 0.5;
            ctx.fillRect(p.rect.x, p.rect.y, p.rect.w, p.rect.h);
            
            if(pImgs[p.uid]) {
                ctx.save();
                const cx = p.rect.x + p.rect.w/2;
                const cy = p.rect.y + p.rect.h/2;
                const size = Math.min(p.rect.w, p.rect.h, 40);
                ctx.beginPath(); ctx.arc(cx, cy, size/2, 0, Math.PI*2); ctx.clip();
                ctx.globalAlpha = 1;
                ctx.drawImage(pImgs[p.uid], cx - size/2, cy - size/2, size, size);
                ctx.restore();
            }
        });

        if (['SPAWNED', 'AIMING', 'FLYING', 'WINNER'].includes(srv.status)) {
            ctx.save();
            ctx.shadowBlur = 15; ctx.shadowColor = "#00f2fe";
            let g = ctx.createRadialGradient(srv.ball.x, srv.ball.y, 2, srv.ball.x, srv.ball.y, 10);
            g.addColorStop(0, '#fff'); g.addColorStop(1, '#00f2fe');
            ctx.fillStyle = g;
            ctx.beginPath(); ctx.arc(srv.ball.x, srv.ball.y, 10, 0, Math.PI*2); ctx.fill();
            ctx.restore();

            if(srv.status === 'AIMING') {
                ctx.save();
                ctx.translate(srv.ball.x, srv.ball.y);
                ctx.rotate(srv.arrowAngle);
                let ag = ctx.createLinearGradient(15,0,55,0);
                ag.addColorStop(0, 'rgba(255,255,255,0)'); ag.addColorStop(1, '#fff');
                ctx.strokeStyle = ag; ctx.lineWidth = 4; ctx.lineCap = 'round';
                ctx.beginPath(); ctx.moveTo(15, 0); ctx.lineTo(45, 0); ctx.stroke();
                ctx.fillStyle = "#fff";
                ctx.beginPath(); ctx.moveTo(45, -5); ctx.lineTo(55, 0); ctx.lineTo(45, 5); ctx.fill();
                ctx.restore();
            }
        }
        requestAnimationFrame(draw);
    }

    draw();
    updateUI();
</script>
</body>
</html>
