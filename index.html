<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balls PvP: Admin & LuckyBlock</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg: #0b0b15; --card: #161625; --blue: #00d2ff; --green: #00ff88; --gold: #ffcc00; }
        body { margin: 0; background: #000; color: white; font-family: sans-serif; display: flex; justify-content: center; overflow: hidden; }
        .app { width: 100%; max-width: 400px; height: 100vh; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .balance { background: var(--card); padding: 8px 15px; border-radius: 12px; border: 1px solid var(--blue); font-weight: bold; }
        
        .game-container { position: relative; width: 300px; height: 300px; margin: 10px auto; border: 4px solid #1a1a2e; overflow: hidden; }
        canvas { background: #000; display: block; }
        
        .view { display: none; flex-direction: column; height: 100%; }
        .view.active { display: flex; }

        .bet-panel { padding: 15px; background: var(--card); border-radius: 20px 20px 0 0; margin-top: auto; }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .chip { background: #0b0b15; border: 1px solid #333; padding: 10px 0; color: white; border-radius: 8px; cursor: pointer; }
        .chip.active { border-color: var(--blue); }

        .admin-btn { background: var(--accent); color: white; padding: 10px; border-radius: 8px; margin-top: 10px; display: none; cursor: pointer; text-align: center; font-weight: bold; border: 2px solid red; }
        .p-item { display: flex; justify-content: space-between; padding: 8px 15px; background: rgba(255,255,255,0.05); margin: 2px 15px; border-radius: 5px; font-size: 13px; }
        
        .nav { height: 60px; display: flex; background: #0a0a15; border-top: 1px solid #1a1a2e; }
        .nav-item { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; }
        
        #lucky-label { position: absolute; top: 10px; left: 10px; color: var(--gold); font-weight: bold; font-size: 12px; display: none; z-index: 10; }
    </style>
</head>
<body>

<div class="app">
    <div id="view-arena" class="view active">
        <div class="header">
            <div>ID: <span id="my-id-display">?</span></div>
            <div class="balance" onclick="claimBonus()">üíé <span id="bal-val">0</span></div>
        </div>

        <div class="game-container">
            <div id="lucky-label">LUCKY BLOCK ACTIVATED!</div>
            <canvas id="gameCanvas" width="300" height="300"></canvas>
            <div id="win-overlay" style="position:absolute; inset:0; background:rgba(0,0,0,0.8); display:none; flex-direction:column; justify-content:center; align-items:center;">
                <img id="win-img" style="width:70px; height:70px; border-radius:50%; border:3px solid var(--green)">
                <h2 id="win-name"></h2>
                <h1 id="win-sum" style="color:var(--green)"></h1>
            </div>
        </div>

        <div id="status-text" style="text-align:center; color:var(--blue); font-weight:bold; margin: 10px 0;">–û–ñ–ò–î–ê–ù–ò–ï...</div>
        <div id="p-list" style="overflow-y:auto; flex-grow:1"></div>

        <div class="bet-panel">
            <div class="chips">
                <button class="chip" onclick="selectChip(10)">10</button>
                <button class="chip" onclick="selectChip(50)">50</button>
                <button class="chip" onclick="selectChip(100)">100</button>
                <button class="chip" onclick="selectChip(500)">500</button>
            </div>
            <button onclick="confirmBet()" style="width:100%; padding:15px; background:var(--green); border:none; border-radius:10px; font-weight:900;">–ü–û–°–¢–ê–í–ò–¢–¨</button>
        </div>
    </div>

    <div id="view-profile" class="view">
        <div style="padding: 20px; text-align:center;">
            <h3>–ü–†–û–§–ò–õ–¨</h3>
            <p>–í–∞—à ID: <span id="prof-id"></span></p>
            <input type="text" id="inp-name" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <button onclick="saveProfile()" style="width:100%; padding:10px; background:var(--blue); border:none; color:white;">–°–û–•–†–ê–ù–ò–¢–¨</button>
            
            <div id="admin-panel" style="margin-top:20px; border: 1px dashed red; padding: 10px; display:none;">
                <h4 style="color:red">–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨</h4>
                <button onclick="socket.emit('admin_add_bot')" style="width:100%; margin-bottom:5px;">–î–û–ë–ê–í–ò–¢–¨ –ë–û–¢–ê</button>
                <button onclick="balance+=1000; updateUI();" style="width:100%;">–ù–ê–ö–†–£–¢–ò–¢–¨ 1000 TON</button>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item" onclick="switchView('arena')">–ê–†–ï–ù–ê</div>
        <div class="nav-item" onclick="switchView('profile')">–ü–†–û–§–ò–õ–¨</div>
    </div>
</div>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    let user = JSON.parse(localStorage.getItem('user_v3')) || { uid: 'u'+Date.now(), name: '–ò–≥—Ä–æ–∫', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed='+Math.random(), id: null };
    let balance = parseFloat(localStorage.getItem('bal_v3')) || 100;
    let game = { players: [], status: 'WAITING', bank: 0, luckyBlock: null };
    let ball = { x: 150, y: 150, vx: 0, vy: 0, active: false };
    let arrowAngle = 0;
    let isAiming = false;
    let lbHit = false;
    let playerImages = {};

    socket.on('assign_id', (id) => {
        if (!user.id) { user.id = id; saveUser(); }
        document.getElementById('my-id-display').innerText = user.id;
        document.getElementById('prof-id').innerText = user.id;
        if (user.id === 1) document.getElementById('admin-panel').style.display = 'block';
    });

    socket.on('sync', (data) => {
        game = data;
        updateUI();
        game.players.forEach(p => {
            if(!playerImages[p.uid]) { const img = new Image(); img.src = p.avatar; playerImages[p.uid] = img; }
        });
    });

    socket.on('start_aiming', (data) => {
        ball.x = data.pos.x; ball.y = data.pos.y;
        ball.vx = 0; ball.vy = 0;
        ball.active = true;
        isAiming = true;
        lbHit = false;
        game.luckyBlock = data.luckyBlock;
        document.getElementById('lucky-label').style.display = 'none';
    });

    socket.on('launch_ball', (data) => {
        isAiming = false;
        const speed = 15;
        ball.vx = Math.cos(arrowAngle) * speed;
        ball.vy = Math.sin(arrowAngle) * speed;
    });

    socket.on('reset_game', () => {
        ball.active = false;
        document.getElementById('win-overlay').style.display = 'none';
        lbHit = false;
    });

    function draw() {
        ctx.clearRect(0, 0, 300, 300);
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π
        let currentY = 0;
        game.players.forEach(p => {
            const h = (p.bet / game.bank) * 300;
            ctx.fillStyle = p.color;
            ctx.globalAlpha = 0.4;
            ctx.fillRect(0, currentY, 300, h);
            if (playerImages[p.uid]) {
                ctx.globalAlpha = 0.1;
                ctx.drawImage(playerImages[p.uid], 110, currentY + h/2 - 40, 80, 80);
            }
            p.yStart = currentY; p.yEnd = currentY + h;
            currentY += h;
        });
        ctx.globalAlpha = 1;

        // Lucky Block
        if (game.luckyBlock && !lbHit) {
            ctx.fillStyle = '#ffcc00';
            ctx.shadowBlur = 10; ctx.shadowColor = 'gold';
            ctx.fillRect(game.luckyBlock.x - 10, game.luckyBlock.y - 10, 20, 20);
            ctx.fillStyle = '#000';
            ctx.fillText("?", game.luckyBlock.x - 3, game.luckyBlock.y + 5);
            ctx.shadowBlur = 0;
        }

        if (ball.active) {
            // –°—Ç—Ä–µ–ª–∫–∞ –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è
            if (isAiming) {
                arrowAngle += 0.1;
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(ball.x, ball.y);
                ctx.lineTo(ball.x + Math.cos(arrowAngle)*40, ball.y + Math.sin(arrowAngle)*40);
                ctx.stroke();
            }

            // –®–∞—Ä
            ball.x += ball.vx; ball.y += ball.vy;
            if (ball.x < 8 || ball.x > 292) ball.vx *= -1;
            if (ball.y < 8 || ball.y > 292) ball.vy *= -1;
            ball.vx *= 0.995; ball.vy *= 0.995;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Lucky Block
            if (game.luckyBlock && !lbHit && Math.hypot(ball.x - game.luckyBlock.x, ball.y - game.luckyBlock.y) < 20) {
                lbHit = true;
                document.getElementById('lucky-label').style.display = 'block';
                setTimeout(() => {
                    game.players.sort(() => Math.random() - 0.5); // –†–∞–Ω–¥–æ–º —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π
                    updateUI();
                }, 3000);
            }

            ctx.beginPath(); ctx.arc(ball.x, ball.y, 8, 0, Math.PI*2);
            ctx.fillStyle = 'white'; ctx.fill();

            if (!isAiming && Math.abs(ball.vx) < 0.15 && !document.getElementById('win-overlay').style.display.includes('flex')) {
                showWinner();
            }
        }
        requestAnimationFrame(draw);
    }

    function showWinner() {
        let winner = game.players.find(p => ball.y >= p.yStart && ball.y <= p.yEnd);
        if (!winner) return;
        
        if (winner.uid === user.uid) {
            balance += game.bank;
            saveUser();
        }

        const overlay = document.getElementById('win-overlay');
        overlay.style.display = 'flex';
        document.getElementById('win-img').src = winner.avatar;
        document.getElementById('win-name').innerText = winner.name;
        document.getElementById('win-sum').innerText = `+${game.bank.toFixed(2)} TON`;
    }

    // –°–ª—É–∂–µ–±–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    let selAmt = 0;
    function selectChip(a) { selAmt = a; document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', parseInt(c.innerText)==a)); }
    function confirmBet() {
        if (balance >= selAmt && selAmt > 0) {
            balance -= selAmt;
            socket.emit('bet', { ...user, bet: selAmt });
            saveUser(); updateUI();
        }
    }
    function updateUI() {
        document.getElementById('bal-val').innerText = balance.toFixed(1);
        document.getElementById('status-text').innerText = game.status === 'BETTING' ? `–î–û –°–¢–ê–†–¢–ê: ${game.timeLeft}—Å` : '–ò–ì–†–ê...';
        document.getElementById('p-list').innerHTML = game.players.map(p => `<div class="p-item"><span>${p.name}</span><b>${((p.bet/game.bank)*100).toFixed(1)}%</b></div>`).join('');
    }
    function switchView(v) { document.getElementById('view-arena').classList.toggle('active', v=='arena'); document.getElementById('view-profile').classList.toggle('active', v=='profile'); }
    function saveUser() { localStorage.setItem('user_v3', JSON.stringify(user)); localStorage.setItem('bal_v3', balance); }
    function saveProfile() { user.name = document.getElementById('inp-name').value; saveUser(); alert("–û–ö"); }

    document.getElementById('prof-id').innerText = user.id || '?';
    document.getElementById('inp-name').value = user.name;
    draw();
</script>
</body>
</html>
