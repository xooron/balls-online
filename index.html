<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balls Pro PvP Square</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg: #05050a; --blue: #00d2ff; --green: #00ff88; }
        body { margin: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; overflow: hidden; }
        .app { width: 100%; max-width: 400px; height: 100vh; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        
        .nav { position: absolute; bottom: 0; left: 0; right: 0; height: 65px; background: #0a0a15; display: flex; border-top: 1px solid #1a1a2e; z-index: 100; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #555; cursor: pointer; }
        .nav-btn.active { color: var(--blue); }

        .view { display: none; flex-direction: column; height: 100%; padding-bottom: 70px; overflow-y: auto; }
        .view.active { display: flex; }

        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .balance-group { display: flex; align-items: center; gap: 5px; }
        .balance { background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 15px; border: 1px solid var(--blue); font-weight: 900; font-size: 14px; }
        .bonus-btn { background: var(--blue); color: #000; border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; font-size: 20px; }

        /* –ö–í–ê–î–†–ê–¢–ù–´–ô –í–ò–ó–£–ê–õ */
        .game-viewport { width: 320px; height: 320px; margin: 0 auto; position: relative; border: 4px solid #1a1a2e; background: #000; flex-shrink: 0; }
        .status-line { text-align: center; margin: 5px 0; font-size: 12px; color: var(--blue); font-weight: bold; }

        .bet-panel { padding: 10px 15px; flex-shrink: 0; }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .chip { background: #111122; border: 2px solid transparent; padding: 12px 0; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; }
        .chip.active { border-color: var(--blue); }
        .bet-btn { width: 100%; padding: 18px; border-radius: 15px; background: var(--green); border: none; font-weight: 900; font-size: 18px; cursor: pointer; }

        .players-list { padding: 10px 20px; background: rgba(0,0,0,0.3); }
        .p-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #161625; font-size: 13px; }
        .p-chance { color: #777; font-size: 11px; margin-left: 5px; }

        .history-list { padding: 10px 20px; }
        .h-item { display: flex; align-items: center; gap: 10px; background: #111; padding: 8px; border-radius: 10px; margin-bottom: 8px; font-size: 12px; }
        .h-ava { width: 30px; height: 30px; border-radius: 50%; }

        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; text-align: center; }
        
        .profile { padding: 30px; align-items: center; }
        .prof-ava { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--blue); margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="app">
    <div id="view-arena" class="view active">
        <div class="header">
            <div style="font-size:20px">üì¶</div>
            <div class="balance-group">
                <div class="balance">üíé <span id="bal-val">1000.0</span></div>
                <button class="bonus-btn" onclick="claimBonus()">+</button>
            </div>
        </div>
        
        <div style="text-align: center">
            <div style="font-size:10px; color:var(--blue)">JACKPOT</div>
            <div style="font-size:24px; font-weight:900"><span id="bank-val">0.00</span> TON</div>
        </div>

        <div class="status-line" id="status-text">–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í...</div>

        <div class="game-viewport">
            <canvas id="gameCanvas" width="320" height="320"></canvas>
            <div id="win-overlay" class="overlay">
                <img src="" id="win-img" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--green)">
                <h2 id="win-name">NAME</h2>
                <h1 id="win-sum" style="color:var(--blue)">+0.00 TON</h1>
            </div>
        </div>

        <div class="bet-panel">
            <div class="chips">
                <button class="chip" onclick="selectChip(10)">10</button>
                <button class="chip" onclick="selectChip(50)">50</button>
                <button class="chip" onclick="selectChip(100)">100</button>
                <button class="chip" onclick="selectChip(500)">500</button>
            </div>
            <button class="bet-btn" onclick="confirmBet()">–ü–û–°–¢–ê–í–ò–¢–¨</button>
        </div>

        <div style="padding: 0 20px; font-size: 12px; color: var(--blue); font-weight: bold;">–ò–ì–†–û–ö–ò:</div>
        <div class="players-list" id="p-list"></div>
        
        <div style="padding: 15px 20px 5px; font-size: 12px; color: var(--blue); font-weight: bold;">–ò–°–¢–û–†–ò–Ø –ò–ì–†:</div>
        <div class="history-list" id="h-list"></div>
    </div>

    <!-- –≠–ö–†–ê–ù –ü–†–û–§–ò–õ–Ø -->
    <div id="view-profile" class="view profile">
        <img src="" id="my-ava" class="prof-ava">
        <input type="text" id="name-input" placeholder="–ù–∏–∫" style="width:100%; margin-bottom:10px; padding:10px; background:#111; border:1px solid #333; color:white; border-radius:10px;">
        <input type="text" id="ava-input" placeholder="URL –ê–≤–∞—Ç–∞—Ä–∫–∏" style="width:100%; margin-bottom:20px; padding:10px; background:#111; border:1px solid #333; color:white; border-radius:10px;">
        <button class="bet-btn" onclick="saveProfile()" style="background:var(--blue)">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <div class="nav">
        <div class="nav-btn active" id="tab-arena" onclick="showView('arena')">–ê–†–ï–ù–ê</div>
        <div class="nav-btn" id="tab-profile" onclick="showView('profile')">–ü–†–û–§–ò–õ–¨</div>
    </div>
</div>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    let user = JSON.parse(localStorage.getItem('balls_user')) || {
        uid: 'u' + Math.floor(Math.random() * 1000000),
        name: '–ò–≥—Ä–æ–∫' + Math.floor(Math.random() * 999),
        avatar: 'https://i.pravatar.cc/100?u=' + Math.random()
    };
    let balance = parseFloat(localStorage.getItem('balls_balance')) || 1000.0;
    let lastBonus = localStorage.getItem('last_bonus') || 0;

    let gameState = { players: [], bank: 0, status: 'BETTING', timeLeft: 15, history: [] };
    let ball = { x: 160, y: 160, vx: 0, vy: 0 };
    let selAmt = 0;
    let images = {};

    function save() {
        localStorage.setItem('balls_user', JSON.stringify(user));
        localStorage.setItem('balls_balance', balance);
        localStorage.setItem('last_bonus', lastBonus);
    }

    function claimBonus() {
        const now = Date.now();
        const diff = now - lastBonus;
        if (diff > 3600000) { // 1 —á–∞—Å = 3,600,000 –º—Å
            balance += 500;
            lastBonus = now;
            save();
            updateUI();
            alert("–í—ã –ø–æ–ª—É—á–∏–ª–∏ –±–æ–Ω—É—Å +500 –º–æ–Ω–µ—Ç!");
        } else {
            const remain = Math.ceil((3600000 - diff) / 60000);
            alert(`–ë–æ–Ω—É—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ ${remain} –º–∏–Ω.`);
        }
    }

    socket.on('sync', (data) => {
        gameState = data;
        updateUI();
        gameState.players.forEach(p => {
            if(!images[p.uid]) { images[p.uid] = new Image(); images[p.uid].src = p.avatar; }
        });
    });

    socket.on('start_game', (data) => {
        gameState.status = 'FLYING';
        ball.x = 160; ball.y = 160;
        ball.vx = Math.cos(data.angle) * 22;
        ball.vy = Math.sin(data.angle) * 22;
    });

    socket.on('reset_game', () => {
        document.getElementById('win-overlay').style.display = 'none';
        ball = { x: 160, y: 160, vx: 0, vy: 0 };
    });

    function confirmBet() {
        if(selAmt <= 0 || balance < selAmt || gameState.status !== 'BETTING') return;
        balance -= selAmt;
        socket.emit('bet', { uid: user.uid, name: user.name, avatar: user.avatar, bet: selAmt });
        selAmt = 0; save(); updateUI();
    }

    function updateUI() {
        document.getElementById('bal-val').innerText = balance.toFixed(1);
        document.getElementById('bank-val').innerText = gameState.bank.toFixed(2);
        
        const status = document.getElementById('status-text');
        if (gameState.players.length < 2) status.innerText = '–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í (–ú–ò–ù. 2)...';
        else if (gameState.status === 'BETTING') status.innerText = `–ù–ê–ß–ê–õ–û –ß–ï–†–ï–ó: ${gameState.timeLeft}–°`;
        else status.innerText = '–ò–ì–†–ê –ò–î–ï–¢!';

        // –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
        document.getElementById('p-list').innerHTML = gameState.players.sort((a,b) => b.bet - a.bet).map(p => {
            const chance = ((p.bet / gameState.bank) * 100).toFixed(1);
            return `
            <div class="p-item">
                <span><b style="color:${p.color}">‚óè</b> ${p.name} <span class="p-chance">${chance}%</span></span>
                <b>${p.bet} TON</b>
            </div>`;
        }).join('');

        // –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä
        document.getElementById('h-list').innerHTML = gameState.history.map(h => `
            <div class="h-item">
                <img src="${h.avatar}" class="h-ava">
                <div style="flex:1"><b>${h.name}</b></div>
                <div style="color:var(--green)">+${h.prize}</div>
                <div style="opacity:0.5">x${h.x}</div>
            </div>
        `).join('');
    }

    function draw() {
        ctx.clearRect(0, 0, 320, 320);
        
        if (gameState.bank > 0) {
            let currentA = 0;
            gameState.players.forEach(p => {
                const slice = (p.bet / gameState.bank) * (Math.PI * 2);
                ctx.beginPath();
                ctx.moveTo(160, 160);
                ctx.arc(160, 160, 500, currentA, currentA + slice);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = 0.8;
                ctx.fill();
                currentA += slice;
            });
            ctx.globalAlpha = 1;
        }

        if (gameState.status === 'FLYING') {
            ball.x += ball.vx; ball.y += ball.vy;
            
            // –ö–í–ê–î–†–ê–¢–ù–´–ï –ì–†–ê–ù–ò–¶–´ (320x320)
            if (ball.x < 8 || ball.x > 312) ball.vx *= -1;
            if (ball.y < 8 || ball.y > 312) ball.vy *= -1;
            
            // –¢—Ä–µ–Ω–∏–µ
            ball.vx *= 0.996; ball.vy *= 0.996;
            
            ctx.beginPath(); ctx.arc(ball.x, ball.y, 8, 0, Math.PI*2);
            ctx.fillStyle = 'white'; ctx.shadowBlur = 10; ctx.shadowColor = 'white';
            ctx.fill(); ctx.shadowBlur = 0;

            if (Math.abs(ball.vx) < 0.1 && Math.abs(ball.vy) < 0.1) showWinner();
        } else {
            ctx.beginPath(); ctx.arc(160, 160, 8, 0, Math.PI*2);
            ctx.fillStyle = 'white'; ctx.fill();
        }
        requestAnimationFrame(draw);
    }

    function showWinner() {
        if (gameState.status !== 'FLYING') return;
        gameState.status = 'END';
        let angle = Math.atan2(ball.y - 160, ball.x - 160);
        if (angle < 0) angle += Math.PI * 2;

        let currentA = 0;
        let winner = gameState.players[0];
        for(let p of gameState.players) {
            let slice = (p.bet / gameState.bank) * (Math.PI * 2);
            if(angle >= currentA && angle <= currentA + slice) { winner = p; break; }
            currentA += slice;
        }

        if (winner.uid === user.uid) { balance += gameState.bank; save(); }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã "—Ö–æ—Å—Ç" (–∫—Ç–æ –ø–µ—Ä–≤—ã–π —É–≤–∏–¥–µ–ª —Ñ–∏–Ω–∏—à)
        // –ß—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π, –æ–±—ã—á–Ω–æ —Å–µ—Ä–≤–µ—Ä —Å—á–∏—Ç–∞–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è, –Ω–æ –∑–¥–µ—Å—å —Å–¥–µ–ª–∞–µ–º —Ç–∞–∫:
        if (winner) {
            socket.emit('add_history', {
                name: winner.name, avatar: winner.avatar, 
                prize: gameState.bank.toFixed(2), 
                x: (gameState.bank / winner.bet).toFixed(1)
            });
        }

        document.getElementById('win-overlay').style.display = 'flex';
        document.getElementById('win-img').src = winner.avatar;
        document.getElementById('win-name').innerText = winner.name;
        document.getElementById('win-sum').innerText = `+${gameState.bank.toFixed(2)} TON`;
        
        setTimeout(() => { document.getElementById('win-overlay').style.display = 'none'; }, 5000);
    }

    function showView(view) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        document.getElementById('tab-' + view).classList.add('active');
        if(view === 'profile') {
            document.getElementById('my-ava').src = user.avatar;
            document.getElementById('name-input').value = user.name;
            document.getElementById('ava-input').value = user.avatar;
        }
    }

    function saveProfile() {
        user.name = document.getElementById('name-input').value;
        user.avatar = document.getElementById('ava-input').value;
        save(); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!'); showView('arena');
    }

    function selectChip(amt) { selAmt = amt; document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', parseInt(c.innerText) === amt)); }

    save(); showView('arena'); draw();
</script>
</body>
</html>

