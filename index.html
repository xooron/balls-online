<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ICE ARENA PvP</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { 
            --bg: #030816; 
            --accent: #00f2fe; 
            --frost: rgba(255, 255, 255, 0.08); 
        }
        
        body { 
            margin: 0; background: var(--bg); color: white; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            overflow: hidden; height: 100vh;
        }

        /* –ö–†–ê–°–ò–í–´–ô –§–û–ù */
        .snow-wrapper { position: fixed; inset: 0; pointer-events: none; z-index: 0; background: radial-gradient(circle at 50% -20%, #1e3a5f 0%, #030816 70%); }
        .snowflake { position: absolute; top: -10px; color: white; animation: fall linear infinite; opacity: 0.6; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }

        /* –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 10; }
        .logo-area { display: flex; flex-direction: column; }
        .logo-text { font-size: 22px; font-weight: 900; color: white; text-shadow: 0 0 15px var(--accent); letter-spacing: 1px; }
        .online-count { font-size: 10px; color: var(--accent); font-weight: bold; margin-top: 2px; }

        .balance-pill { 
            background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 30px; 
            border: 1px solid var(--accent); font-weight: 900; box-shadow: 0 0 15px rgba(0, 242, 254, 0.3);
        }

        /* –°–¢–†–ê–ù–ò–¶–´ */
        .page { display: none; height: calc(100vh - 80px); overflow-y: auto; position: relative; z-index: 5; }
        .page.active { display: block; }

        /* –ê–†–ï–ù–ê */
        .arena-container { display: flex; flex-direction: column; align-items: center; margin-top: 10px; }
        .bank-label { font-size: 11px; color: var(--accent); letter-spacing: 2px; font-weight: bold; }
        .bank-value { font-size: 36px; font-weight: 900; margin-bottom: 15px; }

        .canvas-wrapper { 
            position: relative; width: 320px; height: 320px; 
            border: 4px solid #fff; border-radius: 20px; overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.8), 0 0 20px var(--accent);
        }
        #gameCanvas { width: 320px; height: 320px; display: block; image-rendering: -webkit-optimize-contrast; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .status-bar { margin: 15px 0; font-size: 12px; font-weight: bold; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; }
        .bet-panel { padding: 20px; background: var(--frost); margin: 0 15px; border-radius: 25px; backdrop-filter: blur(10px); }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .chip { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); padding: 12px 0; border-radius: 12px; color: #fff; font-weight: bold; transition: 0.3s; }
        .chip.active { background: var(--accent); border-color: white; color: #000; box-shadow: 0 0 15px var(--accent); }
        
        .main-btn { 
            width: 100%; padding: 18px; border-radius: 20px; border: none; font-weight: 900; 
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%); color: #030816; font-size: 18px;
        }

        /* –ù–ê–í–ë–ê–† */
        .navbar { position: fixed; bottom: 0; width: 100%; height: 75px; background: rgba(3, 8, 22, 0.95); display: flex; border-top: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(15px); }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: #555; transition: 0.3s; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }

        #win-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        
        /* –ü–†–û–§–ò–õ–¨ */
        .profile-header { text-align: center; padding: 40px 20px; }
        .user-pic { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--accent); box-shadow: 0 0 25px var(--accent); margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="snow-wrapper" id="snow"></div>

<div class="header">
    <div class="logo-area" onclick="checkAdmin()">
        <span class="logo-text">ICE ARENA</span>
        <span class="online-count">‚óè <span id="online-val">0</span> –û–ù–õ–ê–ô–ù</span>
    </div>
    <div class="balance-pill">‚ùÑÔ∏è <span id="bal-val">0</span></div>
</div>

<!-- –°–¢–†–ê–ù–ò–¶–ê –ò–ì–†–´ -->
<div id="page-arena" class="page active">
    <div class="arena-container">
        <span class="bank-label">–û–ë–©–ò–ô –ë–ê–ù–ö</span>
        <div class="bank-value"><span id="bank-val">0</span> <span style="font-size: 18px; color: var(--accent);">TON</span></div>
        
        <div class="canvas-wrapper">
            <canvas id="gameCanvas"></canvas>
            <div id="win-overlay">
                <img id="win-img" src="" style="width:100px; height:100px; border-radius:50%; border:3px solid #00ff88;">
                <h2 id="win-name" style="margin: 15px 0 5px 0;"></h2>
                <h1 id="win-sum" style="color:#00ff88; margin:0;"></h1>
            </div>
        </div>
        
        <div id="status-text" class="status-bar">–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í...</div>
    </div>

    <div class="bet-panel">
        <div class="chips">
            <button class="chip" onclick="setBet(1000)">1–ö</button>
            <button class="chip" onclick="setBet(5000)">5–ö</button>
            <button class="chip" onclick="setBet(10000)">10–ö</button>
            <button class="chip" onclick="setBet(50000)">50–ö</button>
        </div>
        <button class="main-btn" onclick="confirmBet()">–°–î–ï–õ–ê–¢–¨ –°–¢–ê–í–ö–£</button>
    </div>

    <div id="players-list" style="padding: 20px; margin-bottom: 100px;"></div>
</div>

<!-- –°–¢–†–ê–ù–ò–¶–ê –ü–†–û–§–ò–õ–Ø -->
<div id="page-profile" class="page">
    <div class="profile-header">
        <img id="u-pic" class="user-pic" src="">
        <h2 id="u-name" style="margin: 0;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <div id="bonus-box" style="margin-top: 20px;">
            <button class="main-btn" id="bonus-btn" onclick="takeBonus()">–ü–û–õ–£–ß–ò–¢–¨ 1000 ‚ùÑÔ∏è</button>
            <p id="bonus-timer" style="color: var(--accent); font-weight: bold;"></p>
        </div>
    </div>
    <div id="history-box" style="padding: 20px;">
        <h3 style="margin-bottom: 15px;">üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã</h3>
        <div id="hist-list"></div>
    </div>
</div>

<div class="navbar">
    <div class="nav-btn active" onclick="showTab('arena')">
        <svg viewBox="0 0 24 24"><path d="M21 16.5C21 16.88 20.79 17.21 20.47 17.38L12.57 21.82C12.41 21.94 12.21 22 12 22C11.79 22 11.59 21.94 11.43 21.82L3.53 17.38C3.21 17.21 3 16.88 3 16.5V7.5C3 7.12 3.21 6.79 3.53 6.62L11.43 2.18C11.59 2.06 11.79 2 12 2C12.21 2 12.41 2.06 12.57 2.18L20.47 6.62C20.79 6.79 21 7.12 21 7.5V16.5Z"/></svg>
        –ê—Ä–µ–Ω–∞
    </div>
    <div class="nav-btn" onclick="showTab('profile')">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
        –ü—Ä–æ—Ñ–∏–ª—å
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ç–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
    const dpr = window.devicePixelRatio || 1;
    canvas.width = 320 * dpr;
    canvas.height = 320 * dpr;
    ctx.scale(dpr, dpr);

    const tgData = tg.initDataUnsafe?.user || { id: 777, first_name: "GUEST", username: "maesexs" };
    let user = { uid: 'tg_'+tgData.id, name: tgData.first_name, avatar: tgData.photo_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${tgData.id}`, username: tgData.username||"" };

    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 5000 —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –≤ –∂–∏–∑–Ω–∏ –∏–≥—Ä–æ–∫–∞
    if (!localStorage.getItem('first_join')) {
        localStorage.setItem('bal_v6', 5000);
        localStorage.setItem('first_join', 'done');
    }
    let balance = parseFloat(localStorage.getItem('bal_v6')) || 0;
    let history = JSON.parse(localStorage.getItem('hist_v6')) || [];
    let lastBonus = parseInt(localStorage.getItem('bonus_v6')) || 0;
    let srv = { players: [], status: 'WAITING', bank: 0, ball: {x:160, y:160} };
    let pImgs = {};
    let selAmt = 1000;

    function createSnow() {
        const w = document.getElementById('snow');
        for(let i=0; i<40; i++) {
            let s = document.createElement('div');
            s.className = 'snowflake'; s.innerHTML = '‚ùÑ';
            s.style.left = Math.random() * 100 + 'vw';
            s.style.animationDuration = (Math.random() * 3 + 4) + 's';
            w.appendChild(s);
        }
    }
    createSnow();

    function showTab(t) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('page-'+t).classList.add('active');
        event.currentTarget.classList.add('active');
        if(t === 'profile') updateProfile();
    }

    function setBet(a) { 
        selAmt = a; 
        document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', parseInt(c.innerText.replace('–ö','000')) === a));
    }

    function confirmBet() {
        if(balance >= selAmt && (srv.status === 'WAITING' || srv.status === 'COUNTDOWN')) {
            balance -= selAmt; localStorage.setItem('bal_v6', balance);
            socket.emit('bet', { ...user, bet: selAmt });
            tg.HapticFeedback.impactOccurred('medium');
            updateUI();
        }
    }

    socket.on('sync', (data) => {
        const oldStatus = srv.status;
        srv = data;
        if (oldStatus !== 'WINNER' && srv.status === 'WINNER') {
            const isMe = srv.winner?.uid === user.uid;
            const myBet = srv.players.find(p => p.uid === user.uid);
            if (myBet) {
                if(isMe) { balance += srv.bank; tg.HapticFeedback.notificationOccurred('success'); }
                history.push({ win: isMe, amt: isMe ? srv.bank : myBet.bet, date: new Date().toLocaleTimeString() });
                localStorage.setItem('bal_v6', balance);
                localStorage.setItem('hist_v6', JSON.stringify(history.slice(-10)));
            }
        }
        updateUI();
        srv.players.forEach(p => { if(!pImgs[p.uid]) { const img = new Image(); img.src = p.avatar; pImgs[p.uid] = img; }});
    });

    function updateUI() {
        document.getElementById('bal-val').innerText = Math.floor(balance);
        document.getElementById('bank-val').innerText = Math.floor(srv.bank);
        document.getElementById('online-val').innerText = srv.online;
        
        const st = document.getElementById('status-text');
        if(srv.status === 'WAITING') st.innerText = "–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í...";
        else if(srv.status === 'COUNTDOWN') st.innerText = `–ù–ê–ß–ê–õ–û –ß–ï–†–ï–ó ${srv.timer} –°–ï–ö`;
        else st.innerText = srv.status;

        document.getElementById('win-overlay').style.display = (srv.status === 'WINNER'?'flex':'none');
        if(srv.winner) {
            document.getElementById('win-img').src = srv.winner.avatar;
            document.getElementById('win-name').innerText = srv.winner.name;
            document.getElementById('win-sum').innerText = `+${Math.floor(srv.bank)} TON`;
        }

        document.getElementById('players-list').innerHTML = srv.players.map(p => `
            <div style="display:flex; align-items:center; background:rgba(255,255,255,0.03); padding:10px; border-radius:15px; margin-bottom:8px; border-left: 4px solid ${p.color}">
                <img src="${p.avatar}" style="width:30px; height:30px; border-radius:50%; margin-right:10px">
                <span style="flex:1; font-weight:bold">${p.name}</span>
                <span style="font-weight:900">${p.bet} <span style="font-size:10px; color:var(--accent)">TON</span></span>
            </div>
        `).join('');
    }

    function draw() {
        ctx.clearRect(0, 0, 320, 320);
        srv.players.forEach(p => {
            if(!p.rect) return;
            ctx.fillStyle = p.color; ctx.globalAlpha = 0.5;
            ctx.fillRect(p.rect.x, p.rect.y, p.rect.w, p.rect.h);
            
            // –ö—Ä—É–≥–ª–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ
            if(pImgs[p.uid]) {
                ctx.save();
                const cx = p.rect.x + p.rect.w/2;
                const cy = p.rect.y + p.rect.h/2;
                const size = Math.min(p.rect.w, p.rect.h, 40);
                ctx.beginPath(); ctx.arc(cx, cy, size/2, 0, Math.PI*2); ctx.clip();
                ctx.globalAlpha = 1;
                ctx.drawImage(pImgs[p.uid], cx - size/2, cy - size/2, size, size);
                ctx.restore();
            }
        });

        if (['SPAWNED', 'AIMING', 'FLYING', 'WINNER'].includes(srv.status)) {
            // –†–∏—Å—É–µ–º –®–∞—Ä (–∫—Ä–∞—Å–∏–≤—ã–π, —Å–æ —Å–≤–µ—á–µ–Ω–∏–µ–º)
            ctx.save();
            ctx.shadowBlur = 15; ctx.shadowColor = varColor('--accent');
            let g = ctx.createRadialGradient(srv.ball.x, srv.ball.y, 2, srv.ball.x, srv.ball.y, 10);
            g.addColorStop(0, '#fff'); g.addColorStop(1, '#00f2fe');
            ctx.fillStyle = g;
            ctx.beginPath(); ctx.arc(srv.ball.x, srv.ball.y, 10, 0, Math.PI*2); ctx.fill();
            ctx.restore();

            // –†–∏—Å—É–µ–º –°—Ç—Ä–µ–ª–∫—É
            if(srv.status === 'AIMING') {
                ctx.save();
                ctx.translate(srv.ball.x, srv.ball.y);
                ctx.rotate(srv.arrowAngle);
                
                // –¢–µ–ª–æ —Å—Ç—Ä–µ–ª–∫–∏ (–≥—Ä–∞–¥–∏–µ–Ω—Ç)
                let ag = ctx.createLinearGradient(0,0,40,0);
                ag.addColorStop(0, 'rgba(255,255,255,0)'); ag.addColorStop(1, '#fff');
                ctx.strokeStyle = ag; ctx.lineWidth = 4; ctx.lineCap = 'round';
                ctx.beginPath(); ctx.moveTo(15, 0); ctx.lineTo(45, 0); ctx.stroke();
                
                // –ù–∞–∫–æ–Ω–µ—á–Ω–∏–∫ —Å—Ç—Ä–µ–ª–∫–∏
                ctx.fillStyle = "#fff";
                ctx.beginPath(); ctx.moveTo(45, -5); ctx.lineTo(55, 0); ctx.lineTo(45, 5); ctx.fill();
                ctx.restore();
            }
        }
        requestAnimationFrame(draw);
    }

    function updateProfile() {
        document.getElementById('u-pic').src = user.avatar;
        document.getElementById('u-name').innerText = user.name;
        
        const rem = 3600000 - (Date.now() - lastBonus);
        if(rem > 0) {
            document.getElementById('bonus-btn').style.display = 'none';
            document.getElementById('bonus-timer').innerText = `–ë–æ–Ω—É—Å —á–µ—Ä–µ–∑: ${Math.floor(rem/60000)}–º`;
        } else {
            document.getElementById('bonus-btn').style.display = 'block';
            document.getElementById('bonus-timer').innerText = '';
        }

        document.getElementById('hist-list').innerHTML = history.reverse().map(h => `
            <div style="display:flex; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:12px; margin-bottom:8px">
                <span style="color:${h.win?'#00ff88':'#ff4757'}; font-weight:bold">${h.win?'–í–´–ò–ì–†–´–®':'–ü–†–û–ò–ì–†–´–®'}</span>
                <span>${Math.floor(h.amt)} TON</span>
            </div>
        `).join('');
    }

    function takeBonus() {
        balance += 1000; lastBonus = Date.now();
        localStorage.setItem('bal_v6', balance); localStorage.setItem('bonus_v6', lastBonus);
        updateProfile(); updateUI();
    }

    function checkAdmin() { if(user.username === 'maesexs') socket.emit('admin_cmd', {username: 'maesexs', type: 'bot'}); }
    function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

    draw(); setBet(1000);
</script>
</body>
</html>
