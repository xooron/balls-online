<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balls Pro PvP v2</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg: #05050a; --blue: #00d2ff; --green: #00ff88; }
        body { margin: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; overflow: hidden; }
        .app { width: 100%; max-width: 400px; height: 100vh; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        
        .header { padding: 15px; display: flex; justify-content: flex-end; align-items: center; }
        .balance { background: rgba(255,255,255,0.05); padding: 8px 15px; border-radius: 20px; border: 1px solid var(--blue); font-weight: 900; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .balance:active { transform: scale(0.95); }

        .view { display: none; flex-direction: column; height: 100%; overflow: hidden; padding-bottom: 70px; }
        .view.active { display: flex; }

        .game-viewport { width: 320px; height: 320px; margin: 0 auto; position: relative; border: 4px solid #1a1a2e; background: #000; overflow: hidden; flex-shrink: 0; }
        
        .loader-wrap { position: absolute; inset: 0; display: none; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.8); z-index: 5; }
        .spinner { width: 35px; height: 35px; border: 3px solid rgba(0,210,255,0.1); border-top: 3px solid var(--blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .status-line { text-align: center; margin: 8px 0; font-size: 12px; color: var(--blue); font-weight: bold; text-transform: uppercase; }

        /* –ü–∞–Ω–µ–ª—å —Å—Ç–∞–≤–æ–∫ */
        .bet-panel { padding: 10px 15px; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .chip { background: #111122; border: 2px solid transparent; padding: 10px 0; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; text-align: center; font-size: 12px; }
        .chip.active { border-color: var(--blue); background: rgba(0, 210, 255, 0.1); }
        
        .custom-bet-row { display: flex; gap: 8px; }
        .bet-input { flex-grow: 1; background: #111; border: 1px solid #333; border-radius: 10px; color: white; padding: 12px; font-size: 14px; outline: none; }
        .bet-input:focus { border-color: var(--blue); }
        .bet-btn { width: 100%; padding: 15px; border-radius: 12px; background: var(--green); border: none; font-weight: 900; font-size: 16px; cursor: pointer; color: #000; }

        .players-list { flex-grow: 1; overflow-y: auto; padding: 0 20px; }
        .p-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #161625; font-size: 13px; }

        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; }
        
        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile-container { padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .prof-ava-big { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--blue); object-fit: cover; }
        .prof-input { width: 100%; background: #111; border: 1px solid #333; padding: 12px; color: white; border-radius: 10px; box-sizing: border-box; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { position: absolute; bottom: 0; left: 0; right: 0; height: 65px; background: #0a0a15; display: flex; border-top: 1px solid #1a1a2e; z-index: 1000; }
        .nav-item { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #555; cursor: pointer; font-weight: bold; }
        .nav-item.active { color: var(--blue); }
    </style>
</head>
<body>

<div class="app">
    <div id="view-arena" class="view active">
        <div class="header">
            <!-- –ö–Ω–æ–ø–∫–∞ –±–æ–Ω—É—Å–∞ –≤ –±–∞–ª–∞–Ω—Å–µ -->
            <div class="balance" onclick="claimBonus()">üíé <span id="bal-val">100.0</span></div>
        </div>

        <div style="text-align: center; margin-bottom: 5px;">
            <div style="font-size:10px; color:var(--blue)">–û–ë–©–ò–ô –ë–ê–ù–ö</div>
            <div style="font-size:24px; font-weight:900"><span id="bank-val">0.00</span> TON</div>
        </div>

        <div class="status-line" id="status-text">–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í...</div>

        <div class="game-viewport">
            <div id="loader" class="loader-wrap">
                <div class="spinner"></div>
                <p style="font-size: 10px; margin-top: 10px; color: var(--blue)">–ñ–î–ï–ú –ò–ì–†–û–ö–û–í (2+)</p>
            </div>
            <canvas id="gameCanvas" width="320" height="320"></canvas>
            <div id="win-overlay" class="overlay">
                <img src="" id="win-img" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--green)">
                <h2 id="win-name" style="margin:5px 0">NAME</h2>
                <h1 id="win-sum" style="color:var(--blue); margin:0">+0.00 TON</h1>
                <p style="font-size:10px; opacity:0.5">–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥ –Ω–∞—á–Ω–µ—Ç—Å—è —Å–∫–æ—Ä–æ</p>
            </div>
        </div>

        <div class="bet-panel">
            <div class="chips">
                <button class="chip" onclick="selectChip(10)">10</button>
                <button class="chip" onclick="selectChip(25)">25</button>
                <button class="chip" onclick="selectChip(50)">50</button>
                <button class="chip" onclick="selectChip(100)">100</button>
            </div>
            <div class="custom-bet-row">
                <input type="number" id="custom-bet-input" class="bet-input" placeholder="–°–≤–æ—è —Å—É–º–º–∞...">
                <button class="bet-btn" style="width: auto; padding: 0 20px;" onclick="confirmBet()">–û–ö</button>
            </div>
            <button class="bet-btn" onclick="confirmBet()">–ü–û–°–¢–ê–í–ò–¢–¨ –í–´–ë–†–ê–ù–ù–û–ï</button>
        </div>

        <div class="players-list" id="p-list"></div>
    </div>

    <div id="view-profile" class="view">
        <div class="profile-container">
            <img src="" id="prof-preview" class="prof-ava-big">
            <div style="font-size:10px; color:#444">ID: <span id="my-uid"></span></div>
            <input type="text" id="inp-name" class="prof-input" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="text" id="inp-ava" class="prof-input" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫—É">
            <button class="bet-btn" onclick="saveProfile()" style="background:var(--blue)">–°–û–•–†–ê–ù–ò–¢–¨</button>
            <p style="font-size: 11px; color: #555; text-align: center;">–ö–ª–∏–∫–∞–π –Ω–∞ –±–∞–ª–∞–Ω—Å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π,<br>—á—Ç–æ–±—ã –∑–∞–±–∏—Ä–∞—Ç—å +10 TON —Ä–∞–∑ –≤ 30 –º–∏–Ω!</p>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" id="btn-arena" onclick="switchView('arena')">–ê–†–ï–ù–ê</div>
        <div class="nav-item" id="btn-profile" onclick="switchView('profile')">–ü–†–û–§–ò–õ–¨</div>
    </div>
</div>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // –û–ë–ù–£–õ–ï–ù–ò–ï –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (–∫–ª—é—á v2_ –æ–±–Ω—É–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å)
    let user = JSON.parse(localStorage.getItem('balls_user_v2')) || {
        uid: 'u' + Math.floor(Math.random() * 1000000),
        name: '–ò–≥—Ä–æ–∫' + Math.floor(Math.random() * 999),
        avatar: 'https://i.pravatar.cc/150?u=' + Math.random()
    };
    
    // –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å—Ç–∞–≤–∏–º 100
    let balance = localStorage.getItem('balls_balance_v2') === null ? 100.0 : parseFloat(localStorage.getItem('balls_balance_v2'));
    let lastBonus = parseInt(localStorage.getItem('balls_bonus_time')) || 0;
    
    let game = { players: [], bank: 0, status: 'WAITING', timeLeft: 15 };
    let ball = { x: 160, y: 160, vx: 0, vy: 0 };
    let selAmt = 0;
    let playerImages = {};

    function init() {
        localStorage.setItem('balls_user_v2', JSON.stringify(user));
        document.getElementById('my-uid').innerText = user.uid;
        document.getElementById('inp-name').value = user.name;
        document.getElementById('inp-ava').value = user.avatar;
        document.getElementById('prof-preview').src = user.avatar;
        saveData();
        updateUI();
    }

    function saveData() {
        localStorage.setItem('balls_balance_v2', balance);
        localStorage.setItem('balls_bonus_time', lastBonus);
    }

    // –ë–û–ù–£–° +10 TON –ö–ê–ñ–î–´–ï 30 –ú–ò–ù–£–¢
    function claimBonus() {
        const now = Date.now();
        const cooldown = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç –≤ –º—Å

        if (now - lastBonus >= cooldown) {
            balance += 10;
            lastBonus = now;
            saveData();
            updateUI();
            alert("–í—ã –ø–æ–ª—É—á–∏–ª–∏ –±–æ–Ω—É—Å +10 TON!");
        } else {
            const remain = Math.ceil((cooldown - (now - lastBonus)) / 60000);
            alert(`–ë–æ–Ω—É—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ ${remain} –º–∏–Ω.`);
        }
    }

    function switchView(v) {
        document.getElementById('view-arena').classList.toggle('active', v === 'arena');
        document.getElementById('view-profile').classList.toggle('active', v === 'profile');
        document.getElementById('btn-arena').classList.toggle('active', v === 'arena');
        document.getElementById('btn-profile').classList.toggle('active', v === 'profile');
    }

    function saveProfile() {
        user.name = document.getElementById('inp-name').value || user.name;
        user.avatar = document.getElementById('inp-ava').value || user.avatar;
        localStorage.setItem('balls_user_v2', JSON.stringify(user));
        document.getElementById('prof-preview').src = user.avatar;
        alert('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    }

    function selectChip(amt) {
        selAmt = amt;
        document.getElementById('custom-bet-input').value = ''; // –°–±—Ä–æ—Å —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
        document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', parseInt(c.innerText) === amt));
    }

    function confirmBet() {
        if(game.status === 'FLYING') return;

        // –ï—Å–ª–∏ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —á—Ç–æ-—Ç–æ –µ—Å—Ç—å, –±–µ—Ä–µ–º –æ—Ç—Ç—É–¥–∞, –∏–Ω–∞—á–µ –∏–∑ —Ñ–∏—à–µ–∫
        let customVal = parseFloat(document.getElementById('custom-bet-input').value);
        let finalBet = !isNaN(customVal) && customVal > 0 ? customVal : selAmt;

        if(finalBet <= 0) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏!");
        if(balance < finalBet) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞!");

        balance -= finalBet;
        socket.emit('bet', { uid: user.uid, name: user.name, avatar: user.avatar, bet: finalBet });
        
        // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
        selAmt = 0;
        document.getElementById('custom-bet-input').value = '';
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        
        saveData();
        updateUI();
    }

    socket.on('sync', (data) => {
        game = data;
        updateUI();
        game.players.forEach(p => {
            if(!playerImages[p.uid]) {
                const img = new Image();
                img.src = p.avatar;
                playerImages[p.uid] = img;
            }
        });
    });

    socket.on('start_game', (data) => {
        game.status = 'FLYING';
        ball = { x: 160, y: 160, vx: Math.cos(data.angle) * 18, vy: Math.sin(data.angle) * 18 };
    });

    socket.on('reset_game', () => {
        document.getElementById('win-overlay').style.display = 'none';
        ball = { x: 160, y: 160, vx: 0, vy: 0 };
    });

    function updateUI() {
        document.getElementById('bal-val').innerText = balance.toFixed(1);
        document.getElementById('bank-val').innerText = game.bank.toFixed(2);
        
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('status-text');

        if (game.players.length < 2) {
            loader.style.display = 'flex';
            statusText.innerText = '–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í (2+)';
        } else {
            loader.style.display = 'none';
            statusText.innerText = game.status === 'BETTING' ? `–î–û –°–¢–ê–†–¢–ê: ${game.timeLeft}–°` : '–ò–ì–†–ê –ò–î–ï–¢!';
        }

        document.getElementById('p-list').innerHTML = game.players.map(p => `
            <div class="p-item">
                <span><b style="color:${p.color}">‚óè</b> ${p.name}</span>
                <b>${p.bet} TON</b>
            </div>
        `).join('');
    }

    function draw() {
        ctx.clearRect(0, 0, 320, 320);
        
        if (game.players.length >= 2) {
            let currentA = 0;
            game.players.forEach(p => {
                const slice = (p.bet / game.bank) * (Math.PI * 2);
                ctx.beginPath();
                ctx.moveTo(160, 160);
                ctx.arc(160, 160, 500, currentA, currentA + slice);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = 0.8;
                ctx.fill();
                ctx.globalAlpha = 1.0;

                const midAngle = currentA + slice / 2;
                const imgX = 160 + Math.cos(midAngle) * 80;
                const imgY = 160 + Math.sin(midAngle) * 80;

                if (playerImages[p.uid] && playerImages[p.uid].complete) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(imgX, imgY, 15, 0, Math.PI * 2);
                    ctx.clip();
                    ctx.drawImage(playerImages[p.uid], imgX - 15, imgY - 15, 30, 30);
                    ctx.restore();
                }
                currentA += slice;
            });
        }

        if (game.status === 'FLYING') {
            ball.x += ball.vx; ball.y += ball.vy;
            if (ball.x < 10 || ball.x > 310) ball.vx *= -1;
            if (ball.y < 10 || ball.y > 310) ball.vy *= -1;
            ball.vx *= 0.995; ball.vy *= 0.995;
            
            ctx.beginPath(); ctx.arc(ball.x, ball.y, 8, 0, Math.PI*2);
            ctx.fillStyle = 'white'; ctx.shadowBlur = 10; ctx.shadowColor = 'white';
            ctx.fill(); ctx.shadowBlur = 0;

            if (Math.abs(ball.vx) < 0.1) showWinner();
        } else if (game.players.length >= 2) {
            ctx.beginPath(); ctx.arc(160, 160, 8, 0, Math.PI*2);
            ctx.fillStyle = 'white'; ctx.fill();
        }
        requestAnimationFrame(draw);
    }

    let winProcessed = false;
    function showWinner() {
        if (game.status !== 'FLYING' || winProcessed) return;
        winProcessed = true;

        let angle = Math.atan2(ball.y - 160, ball.x - 160);
        if (angle < 0) angle += Math.PI * 2;

        let currentA = 0;
        let winner = game.players[0];
        for(let p of game.players) {
            let slice = (p.bet / game.bank) * (Math.PI * 2);
            if(angle >= currentA && angle <= currentA + slice) { winner = p; break; }
            currentA += slice;
        }

        if (winner.uid === user.uid) {
            balance += game.bank;
            saveData();
        }

        document.getElementById('win-overlay').style.display = 'flex';
        document.getElementById('win-img').src = winner.avatar;
        document.getElementById('win-name').innerText = winner.name;
        document.getElementById('win-sum').innerText = `+${game.bank.toFixed(2)} TON`;

        setTimeout(() => {
            winProcessed = false;
            document.getElementById('win-overlay').style.display = 'none';
        }, 5000);
    }

    init();
    draw();
</script>
</body>
</html>
