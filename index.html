<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balls Pro PvP v2.1</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { 
            --bg: #0b0b15; 
            --card-bg: #161625;
            --blue: #00d2ff; 
            --green: #00ff88; 
            --accent: #FF416C;
            --text: #ffffff;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: var(--text); font-family: 'Inter', -apple-system, sans-serif; display: flex; justify-content: center; overflow: hidden; }
        
        .app { width: 100%; max-width: 420px; height: 100vh; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        
        /* Header */
        .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.3), transparent); }
        .balance-card { background: var(--card-bg); padding: 10px 18px; border-radius: 16px; border: 1px solid rgba(0,210,255,0.3); font-weight: 800; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .balance-card:active { transform: scale(0.95); }

        .view { display: none; flex-direction: column; height: 100%; overflow-y: auto; padding-bottom: 90px; }
        .view.active { display: flex; }

        /* Game Board */
        .game-section { position: relative; padding: 10px 0; }
        .game-viewport { width: 280px; height: 280px; margin: 0 auto; position: relative; border-radius: 50%; border: 8px solid var(--card-bg); background: #000; overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        
        canvas { display: block; }

        .loader-wrap { position: absolute; inset: 0; display: none; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 5; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,210,255,0.1); border-top: 4px solid var(--blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Stats */
        .main-stats { text-align: center; margin-top: 15px; }
        .bank-label { font-size: 10px; color: var(--blue); letter-spacing: 2px; font-weight: 800; }
        .bank-value { font-size: 28px; font-weight: 900; background: linear-gradient(white, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Betting Panel */
        .bet-panel { padding: 20px; background: var(--card-bg); border-radius: 24px 24px 0 0; margin-top: auto; border-top: 1px solid rgba(255,255,255,0.05); }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .chip { background: #0b0b15; border: 1px solid #2a2a3a; padding: 12px 0; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .chip.active { border-color: var(--blue); background: rgba(0, 210, 255, 0.1); box-shadow: 0 0 10px rgba(0,210,255,0.2); }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .bet-input { flex: 1; background: #0b0b15; border: 1px solid #2a2a3a; border-radius: 12px; color: white; padding: 0 15px; height: 50px; font-size: 16px; outline: none; transition: 0.3s; }
        .bet-input:focus { border-color: var(--blue); }
        
        .btn-play { width: 100%; height: 55px; border-radius: 16px; background: linear-gradient(45deg, var(--green), #00cc6e); border: none; font-weight: 900; font-size: 16px; cursor: pointer; color: #00331a; box-shadow: 0 4px 15px rgba(0,255,136,0.3); }
        .btn-play:disabled { opacity: 0.5; filter: grayscale(1); }

        /* Players List */
        .players-title { padding: 0 20px; font-size: 12px; color: #555; margin-bottom: 10px; font-weight: bold; }
        .players-list { padding: 0 20px 20px; }
        .p-item { display: flex; align-items: center; background: rgba(255,255,255,0.03); margin-bottom: 8px; padding: 10px 15px; border-radius: 12px; border-left: 4px solid transparent; }
        .p-info { flex-grow: 1; margin-left: 10px; }
        .p-name { font-size: 14px; font-weight: 600; display: block; }
        .p-chance { font-size: 11px; color: var(--blue); font-weight: bold; }
        .p-bet { font-weight: 800; font-size: 14px; }

        .overlay { position: absolute; inset: 0; background: rgba(5,5,10,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; backdrop-filter: blur(8px); }
        
        /* Nav */
        .nav { position: absolute; bottom: 0; width: 100%; height: 75px; background: #0a0a15; display: flex; border-top: 1px solid #1a1a2e; padding-bottom: 10px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #444; cursor: pointer; font-weight: bold; gap: 4px; }
        .nav-item.active { color: var(--blue); }
        .nav-icon { font-size: 20px; }
    </style>
</head>
<body>

<div class="app">
    <div id="view-arena" class="view active">
        <div class="header">
            <div style="font-weight: 900; font-size: 18px; color: var(--blue)">BALLS<span style="color:white">PVP</span></div>
            <div class="balance-card" onclick="claimBonus()">
                <span style="color: var(--blue)">üíé</span>
                <span id="bal-val">100.0</span>
            </div>
        </div>

        <div class="game-section">
            <div class="game-viewport">
                <div id="loader" class="loader-wrap">
                    <div class="spinner"></div>
                    <p style="font-size: 10px; margin-top: 15px; color: var(--blue); letter-spacing: 1px;">–û–ñ–ò–î–ê–ù–ò–ï –°–û–ü–ï–†–ù–ò–ö–û–í</p>
                </div>
                <canvas id="gameCanvas" width="280" height="280"></canvas>
                <div id="win-overlay" class="overlay">
                    <div style="position:relative">
                        <img src="" id="win-img" style="width:90px; height:90px; border-radius:50%; border:4px solid var(--green); box-shadow: 0 0 20px var(--green)">
                        <div style="position:absolute; bottom:-10px; right:-10px; background:var(--green); color:black; padding:4px 8px; border-radius:8px; font-size:10px; font-weight:bold">WINNER</div>
                    </div>
                    <h2 id="win-name" style="margin:20px 0 5px">NAME</h2>
                    <h1 id="win-sum" style="color:var(--green); margin:0; font-size:32px">+0.00</h1>
                    <p style="font-size:12px; opacity:0.5; margin-top:15px">–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥ –Ω–∞—á–Ω–µ—Ç—Å—è —Å–∫–æ—Ä–æ...</p>
                </div>
            </div>
            
            <div class="main-stats">
                <div class="bank-label">–û–ë–©–ò–ô –ë–ê–ù–ö (TON)</div>
                <div class="bank-value" id="bank-val">0.00</div>
                <div id="status-text" style="font-size:11px; margin-top:5px; font-weight:bold; color:var(--accent)">...</div>
            </div>
        </div>

        <div class="players-title">–£–ß–ê–°–¢–ù–ò–ö–ò</div>
        <div class="players-list" id="p-list"></div>

        <div class="bet-panel">
            <div class="chips">
                <button class="chip" onclick="selectChip(10)">10</button>
                <button class="chip" onclick="selectChip(50)">50</button>
                <button class="chip" onclick="selectChip(100)">100</button>
                <button class="chip" onclick="selectChip(500)">500</button>
            </div>
            <div class="input-group">
                <input type="number" id="custom-bet-input" class="bet-input" placeholder="–°–≤–æ—è —Å—É–º–º–∞...">
                <button class="btn-play" id="main-bet-btn" onclick="confirmBet()">–°–¢–ê–í–ö–ê</button>
            </div>
        </div>
    </div>

    <div id="view-profile" class="view">
        <div style="padding: 40px 30px; text-align: center;">
            <div style="position:relative; display:inline-block">
                <img src="" id="prof-preview" style="width:120px; height:120px; border-radius:50%; border:3px solid var(--blue)">
            </div>
            <div style="margin-top:20px; background:var(--card-bg); padding:25px; border-radius:24px; display:flex; flex-direction:column; gap:15px">
                <input type="text" id="inp-name" class="bet-input" placeholder="–ù–∏–∫–Ω–µ–π–º">
                <input type="text" id="inp-ava" class="bet-input" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
                <button class="btn-play" onclick="saveProfile()">–°–û–•–†–ê–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" id="btn-arena" onclick="switchView('arena')">
            <span class="nav-icon">üéÆ</span>–ê–†–ï–ù–ê
        </div>
        <div class="nav-item" id="btn-profile" onclick="switchView('profile')">
            <span class="nav-icon">üë§</span>–ü–†–û–§–ò–õ–¨
        </div>
    </div>
</div>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    let user = JSON.parse(localStorage.getItem('balls_v2_user')) || {
        uid: 'u' + Math.floor(Math.random() * 1000000),
        name: 'Player_' + Math.floor(Math.random() * 999),
        avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + Math.random()
    };
    
    let balance = localStorage.getItem('balls_v2_bal') === null ? 500.0 : parseFloat(localStorage.getItem('balls_v2_bal'));
    let lastBonus = parseInt(localStorage.getItem('balls_v2_bonus')) || 0;
    
    let game = { players: [], bank: 0, status: 'WAITING', timeLeft: 15 };
    let ball = { x: 140, y: 140, vx: 0, vy: 0 };
    let selAmt = 0;
    let playerImages = {};
    let winProcessed = false;

    function init() {
        document.getElementById('inp-name').value = user.name;
        document.getElementById('inp-ava').value = user.avatar;
        document.getElementById('prof-preview').src = user.avatar;
        updateUI();
    }

    function saveData() {
        localStorage.setItem('balls_v2_user', JSON.stringify(user));
        localStorage.setItem('balls_v2_bal', balance);
        localStorage.setItem('balls_v2_bonus', lastBonus);
    }

    function claimBonus() {
        const now = Date.now();
        if (now - lastBonus >= 1800000) {
            balance += 50;
            lastBonus = now;
            saveData();
            updateUI();
            alert("–ë–æ–Ω—É—Å 50 TON –ø–æ–ª—É—á–µ–Ω!");
        } else {
            alert(`–î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ ${Math.ceil((1800000 - (now - lastBonus))/60000)} –º–∏–Ω.`);
        }
    }

    function switchView(v) {
        document.getElementById('view-arena').classList.toggle('active', v === 'arena');
        document.getElementById('view-profile').classList.toggle('active', v === 'profile');
        document.getElementById('btn-arena').classList.toggle('active', v === 'arena');
        document.getElementById('btn-profile').classList.toggle('active', v === 'profile');
    }

    function saveProfile() {
        user.name = document.getElementById('inp-name').value || user.name;
        user.avatar = document.getElementById('inp-ava').value || user.avatar;
        document.getElementById('prof-preview').src = user.avatar;
        saveData();
        alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
    }

    function selectChip(amt) {
        selAmt = amt;
        document.getElementById('custom-bet-input').value = '';
        document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', parseInt(c.innerText) === amt));
    }

    function confirmBet() {
        if(game.status === 'FLYING') return;
        let customVal = parseFloat(document.getElementById('custom-bet-input').value);
        let finalBet = !isNaN(customVal) && customVal > 0 ? customVal : selAmt;

        if(finalBet <= 0 || balance < finalBet) return alert("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –∏–ª–∏ —Å—É–º–º—É!");

        balance -= finalBet;
        socket.emit('bet', { ...user, bet: finalBet });
        saveData();
        updateUI();
    }

    socket.on('sync', (data) => {
        game = data;
        updateUI();
        game.players.forEach(p => {
            if(!playerImages[p.uid]) {
                const img = new Image();
                img.src = p.avatar;
                playerImages[p.uid] = img;
            }
        });
    });

    socket.on('start_game', (data) => {
        game.status = 'FLYING';
        winProcessed = false;
        ball = { x: 140, y: 140, vx: Math.cos(data.angle) * 15, vy: Math.sin(data.angle) * 15 };
    });

    socket.on('reset_game', () => {
        document.getElementById('win-overlay').style.display = 'none';
        ball = { x: 140, y: 140, vx: 0, vy: 0 };
        winProcessed = false;
    });

    function updateUI() {
        document.getElementById('bal-val').innerText = balance.toFixed(1);
        document.getElementById('bank-val').innerText = game.bank.toFixed(2);
        
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('status-text');
        const betBtn = document.getElementById('main-bet-btn');

        if (game.players.length < 2) {
            loader.style.display = 'flex';
            statusText.innerText = '–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í...';
        } else {
            loader.style.display = 'none';
            statusText.innerText = game.status === 'BETTING' ? `–°–¢–ê–†–¢ –ß–ï–†–ï–ó ${game.timeLeft}–°` : '–®–ê–† –í –î–í–ò–ñ–ï–ù–ò–ò!';
        }

        betBtn.disabled = game.status === 'FLYING';

        document.getElementById('p-list').innerHTML = game.players.map(p => {
            const chance = ((p.bet / game.bank) * 100).toFixed(1);
            return `
            <div class="p-item" style="border-left-color: ${p.color}">
                <div class="p-info">
                    <span class="p-name">${p.name}</span>
                    <span class="p-chance">–®–∞–Ω—Å: ${chance}%</span>
                </div>
                <div class="p-bet">${p.bet} TON</div>
            </div>
        `}).join('');
    }

    function draw() {
        ctx.clearRect(0, 0, 280, 280);
        
        if (game.players.length >= 2) {
            let currentA = 0;
            game.players.forEach(p => {
                const slice = (p.bet / game.bank) * (Math.PI * 2);
                ctx.beginPath();
                ctx.moveTo(140, 140);
                ctx.arc(140, 140, 400, currentA, currentA + slice);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = 0.5;
                ctx.fill();
                ctx.globalAlpha = 1.0;
                currentA += slice;
            });
        }

        if (game.status === 'FLYING') {
            ball.x += ball.vx; ball.y += ball.vy;
            if (ball.x < 10 || ball.x > 270) ball.vx *= -1;
            if (ball.y < 10 || ball.y > 270) ball.vy *= -1;
            ball.vx *= 0.992; ball.vy *= 0.992;
            
            ctx.beginPath(); ctx.arc(ball.x, ball.y, 10, 0, Math.PI*2);
            ctx.fillStyle = 'white'; ctx.shadowBlur = 15; ctx.shadowColor = 'white';
            ctx.fill(); ctx.shadowBlur = 0;

            if (Math.abs(ball.vx) < 0.15 && !winProcessed) showWinner();
        }
        requestAnimationFrame(draw);
    }

    function showWinner() {
        winProcessed = true;
        let angle = Math.atan2(ball.y - 140, ball.x - 140);
        if (angle < 0) angle += Math.PI * 2;

        let currentA = 0;
        let winner = game.players[0];
        for(let p of game.players) {
            let slice = (p.bet / game.bank) * (Math.PI * 2);
            if(angle >= currentA && angle <= currentA + slice) { winner = p; break; }
            currentA += slice;
        }

        // –ë–ê–ì –ò–°–ü–†–ê–í–õ–ï–ù: –ù–∞—á–∏—Å–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ú–´ –∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
        if (winner.uid === user.uid) {
            balance += game.bank;
            saveData();
            updateUI();
        }

        document.getElementById('win-overlay').style.display = 'flex';
        document.getElementById('win-img').src = winner.avatar;
        document.getElementById('win-name').innerText = winner.name;
        document.getElementById('win-sum').innerText = `+${game.bank.toFixed(2)} TON`;
    }

    init();
    draw();
</script>
</body>
</html>
