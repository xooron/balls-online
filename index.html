<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balls Pro PvP ONLINE</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg: #05050a;
            --blue: #00d2ff;
            --green: #00ff88;
            --surface: #0f0f1b;
        }

        body {
            margin: 0; background: #000; color: white;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex; justify-content: center; overflow: hidden;
        }

        .app {
            width: 100%; max-width: 400px; height: 100vh;
            background: var(--bg); display: flex; flex-direction: column;
            position: relative;
        }

        .game-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; padding-bottom: 70px; }
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .balance {
            background: rgba(255,255,255,0.05); padding: 8px 16px;
            border-radius: 20px; font-weight: 900; border: 1px solid var(--blue);
            cursor: pointer; transition: 0.2s; user-select: none;
        }
        .balance:active { transform: scale(0.9); }

        .jackpot-card {
            margin: 0 15px 10px; padding: 15px; border-radius: 20px;
            background: linear-gradient(135deg, #0a0a25 0%, #05050a 100%);
            border: 1px solid rgba(0, 210, 255, 0.2); text-align: center;
        }
        .jackpot-val { font-size: 32px; font-weight: 900; }

        .game-viewport {
            width: 320px; height: 320px; margin: 0 auto;
            position: relative; border-radius: 50%; 
            overflow: hidden; border: 6px solid #1a1a2e;
            background: #000;
        }

        .status-line { text-align: center; margin: 10px 0; font-size: 12px; color: var(--blue); font-weight: bold; text-transform: uppercase; }

        .bet-panel { padding: 10px 15px; }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .chip {
            background: #111122; border: 2px solid transparent; padding: 12px 0;
            border-radius: 12px; color: white; font-weight: bold; cursor: pointer;
        }
        .chip.active { border-color: var(--blue); background: rgba(0,210,255,0.1); }
        .bet-btn {
            width: 100%; padding: 18px; border-radius: 15px;
            background: var(--green); border: none; color: #000;
            font-weight: 900; font-size: 18px; cursor: pointer;
        }
        .bet-btn:disabled { background: #333; color: #777; cursor: not-allowed; }

        .players-list { flex-grow: 1; overflow-y: auto; padding: 5px 20px; background: rgba(0,0,0,0.4); }
        .p-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 0; border-bottom: 1px solid #161625; font-size: 13px; 
        }

        .overlay {
            position: absolute; inset: 0; background: rgba(5, 5, 10, 0.95);
            display: none; flex-direction: column; justify-content: center;
            align-items: center; z-index: 1000; text-align: center;
        }

        .nav-bar {
            position: absolute; bottom: 0; left: 0; right: 0; height: 70px;
            background: #0a0a15; border-top: 1px solid #1a1a2e;
            display: flex; justify-content: space-around; align-items: center;
        }
        .nav-item { flex: 1; text-align: center; color: #555; cursor: pointer; font-size: 10px; font-weight: bold; }
        .nav-item.active { color: var(--blue); }
    </style>
</head>
<body>

<div class="app">
    <div id="arena-view" class="game-content">
        <div class="header">
            <div style="font-size: 20px;">üèÜ</div>
            <div class="balance" id="topup">üíé <span id="bal-val">1000.0</span></div>
        </div>

        <div class="jackpot-card">
            <div style="font-size:11px; color:var(--blue);">–û–ë–©–ò–ô –ë–ê–ù–ö</div>
            <div class="jackpot-val"><span id="bank-val">0.00</span> <small style="font-size:14px; opacity:0.5">TON</small></div>
        </div>

        <div class="status-line" id="status-text">–ó–ê–ì–†–£–ó–ö–ê...</div>

        <div class="game-viewport">
            <canvas id="gameCanvas" width="320" height="320"></canvas>
            
            <div id="win-overlay" class="overlay">
                <img src="" id="win-img" style="width:100px; height:100px; border-radius:50%; border:4px solid var(--green); margin-bottom:15px;">
                <h2 id="win-name" style="margin:0">NAME</h2>
                <h1 id="win-sum" style="color:var(--blue); margin:5px 0">+0.00 TON</h1>
                <div id="win-x" style="background:var(--green); color:#000; padding:5px 15px; border-radius:10px; font-weight:900;">x0.00</div>
                <p style="font-size:12px; color:#777; margin-top:15px;">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ –Ω–∞—á–Ω–µ—Ç—Å—è —Å–∫–æ—Ä–æ...</p>
            </div>
        </div>

        <div class="bet-panel">
            <div class="chips">
                <button class="chip" onclick="selectChip(10)">10</button>
                <button class="chip" onclick="selectChip(50)">50</button>
                <button class="chip" onclick="selectChip(100)">100</button>
                <button class="chip" onclick="selectChip(500)">500</button>
            </div>
            <button class="bet-btn" id="bet-confirm" onclick="confirmBet()">–ü–û–°–¢–ê–í–ò–¢–¨</button>
        </div>

        <div class="players-list" id="p-list"></div>
    </div>
</div>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∏–≥—Ä–æ–∫–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if(!localStorage.getItem('balls_uid')) {
        localStorage.setItem('balls_uid', 'u_' + Math.random().toString(36).substr(2, 9));
    }

    let user = { 
        uid: localStorage.getItem('balls_uid'),
        name: '–ò–≥—Ä–æ–∫_' + localStorage.getItem('balls_uid').substr(2,3), 
        avatar: 'https://i.pravatar.cc/150?u=' + localStorage.getItem('balls_uid')
    };

    let balance = 1000.0, bank = 0, players = [], state = 'BETTING', timeLeft = 15;
    let ball = { x: 160, y: 160, vx: 0, vy: 0 };
    let selAmt = 0;
    let playerImages = {}; // –ö–µ—à –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫

    // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
    if(localStorage.getItem('balls_pro_balance')) {
        balance = parseFloat(localStorage.getItem('balls_pro_balance'));
    }

    function saveData() {
        localStorage.setItem('balls_pro_balance', balance);
    }

    // –ö–ª–∏–∫ –ø–æ –±–∞–ª–∞–Ω—Å—É
    document.getElementById('topup').onclick = () => {
        balance += 1;
        saveData();
        updateUI();
    };

    function selectChip(amt) {
        if(state !== 'BETTING') return;
        selAmt = amt;
        document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', parseInt(c.innerText) === amt));
    }

    function confirmBet() {
        if(selAmt <= 0 || balance < selAmt || state !== 'BETTING') return;
        socket.emit('bet', { uid: user.uid, name: user.name, avatar: user.avatar, bet: selAmt });
        balance -= selAmt;
        saveData();
        selAmt = 0;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        updateUI();
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    socket.on('sync', (gs) => {
        bank = gs.bank;
        players = gs.players;
        timeLeft = gs.timeLeft;
        state = gs.status;
        
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–æ–∫
        players.forEach(p => {
            if(!playerImages[p.uid]) {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = p.avatar;
                playerImages[p.uid] = img;
            }
        });

        updateUI();
    });

    socket.on('start_game', (data) => {
        state = 'FLYING';
        ball = { x: 160, y: 160, vx: Math.cos(data.angle) * 25, vy: Math.sin(data.angle) * 25 };
    });

    socket.on('reset_game', () => {
        document.getElementById('win-overlay').style.display = 'none';
        ball = { x: 160, y: 160, vx: 0, vy: 0 };
    });

    function updateUI() {
        document.getElementById('bal-val').innerText = balance.toFixed(1);
        document.getElementById('bank-val').innerText = bank.toFixed(2);
        
        const statusTxt = document.getElementById('status-text');
        if (players.length < 2 && state === 'BETTING') {
            statusTxt.innerText = `–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í... (${players.length}/2)`;
        } else if (state === 'BETTING') {
            statusTxt.innerText = `–ù–ê–ß–ê–õ–û –ß–ï–†–ï–ó: ${timeLeft}–°`;
        } else {
            statusTxt.innerText = `–ò–ì–†–ê –ò–î–ï–¢!`;
        }

        const list = document.getElementById('p-list');
        list.innerHTML = players.sort((a,b) => b.bet - a.bet).map(p => `
            <div class="p-item">
                <span><b style="color:${p.color}">‚óè</b> ${p.name}</span>
                <b>${p.bet} TON</b>
            </div>
        `).join('');

        document.getElementById('bet-confirm').disabled = (state !== 'BETTING');
    }

    function draw() {
        ctx.clearRect(0, 0, 320, 320);
        const centerX = 160, centerY = 160;

        if (bank > 0) {
            let currentA = 0;
            players.forEach(p => {
                const slice = (p.bet / bank) * (Math.PI * 2);
                
                // –†–∏—Å—É–µ–º —Ü–≤–µ—Ç–Ω–æ–π —Å–µ–∫—Ç–æ—Ä
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, 400, currentA, currentA + slice);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = 0.8;
                ctx.fill();
                ctx.globalAlpha = 1;

                // –†–∏—Å—É–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –≤ —Å–µ–∫—Ç–æ—Ä–µ
                const midAngle = currentA + slice / 2;
                const imgX = centerX + Math.cos(midAngle) * 80;
                const imgY = centerY + Math.sin(midAngle) * 80;
                
                if(playerImages[p.uid] && playerImages[p.uid].complete) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(imgX, imgY, 20, 0, Math.PI*2);
                    ctx.clip();
                    ctx.drawImage(playerImages[p.uid], imgX-20, imgY-20, 40, 40);
                    ctx.restore();
                }

                currentA += slice;
            });
        } else {
            // –§–æ–Ω –µ—Å–ª–∏ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤
            ctx.fillStyle = '#111';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 160, 0, Math.PI*2);
            ctx.fill();
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.fillText("–ñ–î–ï–ú –°–¢–ê–í–û–ö", centerX, centerY);
        }

        // –†–∏—Å—É–µ–º —à–∞—Ä–∏–∫
        if (state === 'FLYING') {
            ball.x += ball.vx; ball.y += ball.vy;
            if (ball.x < 10 || ball.x > 310) ball.vx *= -1;
            if (ball.y < 10 || ball.y > 310) ball.vy *= -1;
            ball.vx *= 0.994; ball.vy *= 0.994;

            ctx.beginPath();
            ctx.arc(ball.x, ball.y, 10, 0, Math.PI*2);
            ctx.fillStyle = 'white';
            ctx.shadowBlur = 15;
            ctx.shadowColor = 'white';
            ctx.fill();
            ctx.shadowBlur = 0;

            if (Math.abs(ball.vx) < 0.1 && Math.abs(ball.vy) < 0.1) {
                showWinner();
            }
        } else {
            ctx.beginPath();
            ctx.arc(centerX, centerY, 8, 0, Math.PI*2);
            ctx.fillStyle = 'white';
            ctx.fill();
        }

        requestAnimationFrame(draw);
    }

    function showWinner() {
        if (state !== 'FLYING') return;
        state = 'END';
        
        let angle = Math.atan2(ball.y - 160, ball.x - 160);
        if (angle < 0) angle += Math.PI * 2;

        let currentA = 0;
        let winner = players[0];
        for(let p of players) {
            let slice = (p.bet / bank) * (Math.PI * 2);
            if(angle >= currentA && angle <= currentA + slice) {
                winner = p;
                break;
            }
            currentA += slice;
        }

        if(winner.uid === user.uid) {
            balance += bank;
            saveData();
        }

        const xMult = (bank / winner.bet).toFixed(2);
        const winOverlay = document.getElementById('win-overlay');
        document.getElementById('win-img').src = winner.avatar;
        document.getElementById('win-name').innerText = winner.name;
        document.getElementById('win-sum').innerText = `+${bank.toFixed(2)} TON`;
        document.getElementById('win-x').innerText = `x${xMult}`;
        winOverlay.style.display = 'flex';

        updateUI();

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 6 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            winOverlay.style.display = 'none';
        }, 6000);
    }

    updateUI();
    draw();
</script>
</body>
</html>
