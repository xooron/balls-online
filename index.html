<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Balls PvP Bot</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º SDK Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg: #05050a;
            --blue: #00d2ff;
            --green: #00ff88;
            --tg-bg: var(--tg-theme-bg-color, #05050a);
            --tg-text: var(--tg-theme-text-color, #ffffff);
        }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            color: white; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .app { 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –≤—ã—Ä–µ–∑ —Å–≤–µ—Ä—Ö—É –≤ Telegram */
        .header { 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-top: env(safe-area-inset-top);
        }

        .balance { 
            background: rgba(0, 210, 255, 0.15); 
            padding: 6px 12px; 
            border-radius: 100px; 
            border: 1px solid var(--blue); 
            font-weight: 800;
            font-size: 14px;
        }

        .game-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .game-viewport { 
            width: 90vw; 
            height: 90vw; 
            max-width: 340px; 
            max-height: 340px;
            position: relative; 
            border: 3px solid #1a1a2e; 
            background: #000; 
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,210,255,0.2);
        }
        
        canvas { width: 100%; height: 100%; display: block; }

        .status-line { margin: 10px 0; font-size: 13px; color: var(--blue); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }

        .bet-panel { 
            padding: 15px; 
            background: rgba(255,255,255,0.03);
            border-radius: 20px 20px 0 0;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }

        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
        .chip { 
            background: #161625; 
            border: 2px solid transparent; 
            padding: 12px 0; 
            border-radius: 12px; 
            color: white; 
            font-weight: bold; 
            cursor: pointer;
            transition: 0.2s;
        }
        .chip.active { border-color: var(--blue); background: rgba(0, 210, 255, 0.2); transform: scale(0.95); }

        .bet-btn { 
            width: 100%; 
            padding: 16px; 
            border-radius: 15px; 
            background: var(--green); 
            border: none; 
            font-weight: 900; 
            font-size: 16px; 
            color: #000;
            text-transform: uppercase;
        }

        .players-list { height: 120px; overflow-y: auto; width: 100%; padding: 0 15px; margin-bottom: 10px; }
        .p-item { 
            display: flex; justify-content: space-between; 
            padding: 8px 12px; background: rgba(255,255,255,0.05); 
            margin-bottom: 6px; border-radius: 10px; font-size: 13px;
        }

        .overlay { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); 
            display: none; flex-direction: column; justify-content: center; 
            align-items: center; z-index: 100; border-radius: 12px;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫–∞–∫ –≤ –¢–ì */
        .nav { display: flex; border-top: 1px solid #1a1a2e; background: #0a0a15; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; padding: 12px; text-align: center; font-size: 11px; opacity: 0.5; }
        .nav-item.active { opacity: 1; color: var(--blue); border-top: 2px solid var(--blue); }
    </style>
</head>
<body>

<div class="app">
    <div id="view-arena" class="view active" style="display: flex; flex-direction: column; height: 100%;">
        <div class="header">
            <div id="user-info" style="display: flex; align-items: center; gap: 8px;">
                <img id="my-avatar" src="" style="width: 30px; height: 30px; border-radius: 50%; display: none;">
                <span id="my-name" style="font-size: 14px; font-weight: 600;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="balance">üíé <span id="bal-val">100</span></div>
        </div>

        <div style="text-align: center; margin: 10px 0;">
            <div style="font-size:10px; color:var(--blue); opacity: 0.8;">–û–ë–©–ò–ô –ë–ê–ù–ö</div>
            <div style="font-size:28px; font-weight:900"><span id="bank-val">0.00</span> <span style="font-size: 16px;">TON</span></div>
        </div>

        <div class="game-container">
            <div class="status-line" id="status-text">–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í</div>
            <div class="game-viewport">
                <canvas id="gameCanvas" width="340" height="340"></canvas>
                <div id="win-overlay" class="overlay">
                    <img src="" id="win-img" style="width:70px; height:70px; border-radius:50%; border:3px solid var(--green)">
                    <h2 id="win-name" style="margin:10px 0">NAME</h2>
                    <h1 id="win-sum" style="color:var(--blue); margin:0">+0.00 TON</h1>
                </div>
            </div>
        </div>

        <div class="players-list" id="p-list"></div>

        <div class="bet-panel">
            <div class="chips">
                <button class="chip" onclick="setBet(5)">5</button>
                <button class="chip" onclick="setBet(10)">10</button>
                <button class="chip" onclick="setBet(25)">25</button>
                <button class="chip" onclick="setBet(50)">50</button>
            </div>
            <button class="bet-btn" id="main-bet-btn" onclick="confirmBet()">–ü–û–°–¢–ê–í–ò–¢–¨</button>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    tg.enableClosingConfirmation(); // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è

    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
    const webAppData = tg.initDataUnsafe.user || {
        id: Math.floor(Math.random() * 1000),
        first_name: "–ò–≥—Ä–æ–∫",
        photo_url: "https://api.dicebear.com/7.x/pixel-art/svg?seed=1"
    };

    let user = {
        uid: 'tg_' + webAppData.id,
        name: webAppData.first_name,
        avatar: webAppData.photo_url || `https://api.dicebear.com/7.x/bottts/svg?seed=${webAppData.id}`,
        id: webAppData.id
    };

    document.getElementById('my-name').innerText = user.name;
    if(webAppData.photo_url) {
        document.getElementById('my-avatar').src = user.avatar;
        document.getElementById('my-avatar').style.display = 'block';
    }

    let balance = parseFloat(localStorage.getItem('bal_v2')) || 1000.0;
    let game = { players: [], status: 'WAITING', bank: 0 };
    let ball = { x: 170, y: 170, vx: 0, vy: 0, active: false, trail: [] };
    let arrowAngle = 0;
    let isAiming = false;
    let selAmt = 0;
    let playerImages = {};

    socket.emit('auth', user);

    socket.on('sync', (data) => {
        game = data;
        updateUI();
        game.players.forEach(p => {
            if(!playerImages[p.uid]) {
                const img = new Image();
                img.src = p.avatar;
                playerImages[p.uid] = img;
            }
        });
    });

    socket.on('start_aiming', (data) => {
        ball = { x: data.pos.x, y: data.pos.y, vx: 0, vy: 0, active: true, trail: [] };
        isAiming = true;
        if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    });

    socket.on('launch_ball', () => {
        isAiming = false;
        ball.vx = Math.cos(arrowAngle) * 12;
        ball.vy = Math.sin(arrowAngle) * 12;
    });

    socket.on('reset_game', () => {
        ball.active = false;
        document.getElementById('win-overlay').style.display = 'none';
    });

    function setBet(a) {
        selAmt = a;
        if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', parseInt(c.innerText) === a));
    }

    function confirmBet() {
        if (balance >= selAmt && selAmt > 0) {
            balance -= selAmt;
            socket.emit('bet', { ...user, bet: selAmt });
            saveAll();
            updateUI();
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        } else {
            tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ (–∏–∑ —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞ —Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π –ø–æ–¥ 340px)
    function drawTerritories() {
        if (game.players.length === 0) return;
        let x = 0, y = 0, w = 340, h = 340;
        let horizontal = true;
        const sorted = [...game.players].sort((a, b) => b.bet - a.bet);
        let remainingBank = game.bank;

        sorted.forEach((p) => {
            const ratio = p.bet / remainingBank;
            let tw, th;
            if (horizontal) {
                tw = w; th = h * ratio;
                p.rect = { x, y, w: tw, h: th };
                y += th; h -= th;
            } else {
                tw = w * ratio; th = h;
                p.rect = { x, y, w: tw, h: th };
                x += tw; w -= tw;
            }
            remainingBank -= p.bet;
            horizontal = !horizontal;

            ctx.fillStyle = p.color;
            ctx.globalAlpha = 0.3;
            ctx.fillRect(p.rect.x, p.rect.y, p.rect.w, p.rect.h);
            ctx.strokeStyle = p.color;
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.5;
            ctx.strokeRect(p.rect.x, p.rect.y, p.rect.w, p.rect.h);
        });
        ctx.globalAlpha = 1;
    }

    function drawBall() {
        if (!ball.active) return;
        
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, 8, 0, Math.PI * 2);
        ctx.fillStyle = "#fff";
        ctx.shadowBlur = 15;
        ctx.shadowColor = varColor('--blue');
        ctx.fill();
        ctx.shadowBlur = 0;

        if (isAiming) {
            arrowAngle += 0.07;
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = "white";
            ctx.beginPath();
            ctx.moveTo(ball.x, ball.y);
            ctx.lineTo(ball.x + Math.cos(arrowAngle) * 40, ball.y + Math.sin(arrowAngle) * 40);
            ctx.stroke();
            ctx.setLineDash([]);
        }
    }

    function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }

    function draw() {
        ctx.clearRect(0, 0, 340, 340);
        drawTerritories();
        drawBall();

        if (ball.active && !isAiming) {
            ball.x += ball.vx; ball.y += ball.vy;
            if (ball.x < 10 || ball.x > 330) ball.vx *= -1;
            if (ball.y < 10 || ball.y > 330) ball.vy *= -1;
            ball.vx *= 0.992; ball.vy *= 0.992;

            if (Math.abs(ball.vx) < 0.1 && !document.getElementById('win-overlay').style.display.includes('flex')) {
                showWinner();
            }
        }
        requestAnimationFrame(draw);
    }

    function showWinner() {
        let winner = game.players.find(p => 
            ball.x >= p.rect.x && ball.x <= p.rect.x + p.rect.w &&
            ball.y >= p.rect.y && ball.y <= p.rect.y + p.rect.h
        );
        if (winner) {
            if (winner.uid === user.uid) { 
                balance += game.bank; 
                saveAll(); 
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            }
            document.getElementById('win-overlay').style.display = 'flex';
            document.getElementById('win-img').src = winner.avatar;
            document.getElementById('win-name').innerText = winner.name;
            document.getElementById('win-sum').innerText = `+${game.bank.toFixed(2)} TON`;
        }
    }

    function updateUI() {
        document.getElementById('bal-val').innerText = Math.floor(balance);
        document.getElementById('bank-val').innerText = game.bank.toFixed(2);
        
        if (game.status === 'BETTING') {
            document.getElementById('status-text').innerText = `–°–¢–ê–†–¢ –ß–ï–†–ï–ó: ${game.timeLeft}–°`;
            document.getElementById('main-bet-btn').disabled = false;
            document.getElementById('main-bet-btn').style.opacity = "1";
        } else {
            document.getElementById('status-text').innerText = game.status === 'WAITING' ? '–û–ñ–ò–î–ê–ù–ò–ï –°–¢–ê–í–û–ö...' : '–ò–ì–†–ê –í –ü–†–û–¶–ï–°–°–ï';
            document.getElementById('main-bet-btn').disabled = true;
            document.getElementById('main-bet-btn').style.opacity = "0.5";
        }
        
        document.getElementById('p-list').innerHTML = game.players
            .sort((a,b) => b.bet - a.bet)
            .map(p => `
            <div class="p-item" style="border-left: 4px solid ${p.color}">
                <span>${p.name}</span>
                <span style="font-weight:900">${p.bet} TON</span>
            </div>
        `).join('');
    }

    function saveAll() { localStorage.setItem('bal_v2', balance); }

    draw();
</script>
</body>
</html>
