<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balls Pro PvP ONLINE</title>
    <!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú SOCKET.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg: #05050a;
            --blue: #00d2ff;
            --green: #00ff88;
            --surface: #0f0f1b;
            --user-color: #00ffff;
        }

        body {
            margin: 0; background: #000; color: white;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex; justify-content: center; overflow: hidden;
        }

        .app {
            width: 100%; max-width: 400px; height: 100vh;
            background: var(--bg); display: flex; flex-direction: column;
            position: relative;
        }

        .game-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-bottom: 70px;
        }

        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        
        .history-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; font-size: 20px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: 0.2s;
        }

        .balance {
            background: rgba(255,255,255,0.05); padding: 8px 16px;
            border-radius: 20px; font-weight: 900; border: 1px solid var(--blue);
            cursor: pointer; font-size: 16px;
        }

        .jackpot-card {
            margin: 0 15px 10px; padding: 15px; border-radius: 20px;
            background: linear-gradient(135deg, #0a0a25 0%, #05050a 100%);
            border: 1px solid rgba(0, 210, 255, 0.2);
            text-align: center; flex-shrink: 0;
        }
        .jackpot-val { font-size: 32px; font-weight: 900; }

        .game-viewport {
            width: 320px; height: 320px; margin: 0 auto;
            position: relative; border-radius: 35px; 
            overflow: hidden; border: 6px solid #1a1a2e;
            flex-shrink: 0; background: #000;
        }

        .status-line { text-align: center; margin: 10px 0; font-size: 11px; color: #555; letter-spacing: 1px; }

        .bet-panel { padding: 10px 15px; flex-shrink: 0; }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .chip {
            background: #111122; border: 2px solid transparent; padding: 12px 0;
            border-radius: 12px; color: white; font-weight: bold; cursor: pointer;
        }
        .chip.active { border-color: var(--blue); background: rgba(0,210,255,0.1); }
        .bet-btn {
            width: 100%; padding: 18px; border-radius: 15px;
            background: var(--green); border: none; color: #000;
            font-weight: 900; font-size: 18px; cursor: pointer;
        }

        .players-list { flex-grow: 1; overflow-y: auto; padding: 5px 20px; background: rgba(0,0,0,0.4); }
        .p-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 0; border-bottom: 1px solid #161625; font-size: 14px; 
        }
        
        .p-chance {
            font-size: 10px; background: rgba(0,210,255,0.15); color: var(--blue);
            padding: 2px 6px; border-radius: 6px; font-weight: bold; margin-left: 8px;
        }

        .overlay {
            position: absolute; inset: 0; background: var(--bg);
            display: none; flex-direction: column; justify-content: center;
            align-items: center; z-index: 1000; text-align: center;
        }
        .history-overlay { justify-content: flex-start; padding-top: 50px; background: rgba(0,0,0,0.96); }
        
        .profile-container { width: 80%; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--blue); margin-bottom: 20px; object-fit: cover; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; margin-left: 10px;}
        .profile-input {
            width: 100%; background: #111122; border: 1px solid #333;
            padding: 12px; border-radius: 12px; color: white; box-sizing: border-box;
        }

        .nav-bar {
            position: absolute; bottom: 0; left: 0; right: 0; height: 70px;
            background: #0a0a15; border-top: 1px solid #1a1a2e;
            display: flex; justify-content: space-around; align-items: center; z-index: 1100;
        }
        .nav-item {
            flex: 1; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer;
            color: #555; transition: 0.2s; text-decoration: none;
        }
        .nav-item.active { color: var(--blue); }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }
        .nav-label { font-size: 10px; font-weight: bold; text-transform: uppercase; }

        .w-avatar { width: 90px; height: 90px; border-radius: 50%; border: 4px solid var(--green); margin-bottom: 15px; }
        .history-list { width: 90%; max-height: 70vh; overflow-y: auto; margin-top: 20px; }
        .history-item {
            display: flex; align-items: center; background: #111; 
            margin-bottom: 10px; padding: 10px; border-radius: 12px;
            border-left: 4px solid var(--blue);
        }
        .hist-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; }
        .hist-info { flex-grow: 1; text-align: left; }
        .hist-x { color: var(--green); font-weight: 900; margin-left: 10px; }
    </style>
</head>
<body>

<div class="app">
    <div id="arena-view" class="game-content">
        <div class="header">
            <div class="history-btn" onclick="toggleHistory(true)">üïí</div>
            <div class="balance" id="topup">üíé <span id="bal-val">100.0</span></div>
        </div>

        <div class="jackpot-card">
            <div style="font-size:11px; color:var(--blue); margin-bottom:4px">JACKPOT</div>
            <div class="jackpot-val"><span id="bank-val">0.00</span> <small style="font-size:14px; opacity:0.5">TON</small></div>
        </div>

        <div class="status-line" id="status-text">–û–ñ–ò–î–ê–ù–ò–ï –°–¢–ê–í–û–ö... <span id="timer">15</span>–°</div>

        <div class="game-viewport">
            <canvas id="gameCanvas" width="340" height="340"></canvas>
            
            <div id="win-overlay" class="overlay">
                <img src="" id="win-img" class="w-avatar">
                <h2 id="win-name" style="margin:0">NAME</h2>
                <h1 id="win-sum" style="color:var(--blue); margin:5px 0">+0.00 TON</h1>
                <div style="background:var(--green); color:#000; padding:4px 12px; border-radius:8px; font-weight:900;" id="win-x">x0.00</div>
                <button onclick="resetGameUI()" style="margin-top:25px; padding:14px 45px; border-radius:12px; border:none; background:var(--blue); color:white; font-weight:bold; cursor:pointer;">–î–ê–õ–ï–ï</button>
            </div>

            <div id="history-overlay" class="overlay history-overlay">
                <h2>–ò–°–¢–û–†–ò–Ø –ò–ì–†</h2>
                <div class="history-list" id="hist-content"></div>
                <button onclick="toggleHistory(false)" style="margin-top:20px; padding:10px 30px; border-radius:10px; border:none; background:#333; color:white;">–ó–ê–ö–†–´–¢–¨</button>
            </div>
        </div>

        <div class="bet-panel">
            <div class="chips">
                <button class="chip" onclick="selectChip(10)">10</button>
                <button class="chip" onclick="selectChip(50)">50</button>
                <button class="chip" onclick="selectChip(100)">100</button>
                <button class="chip" onclick="selectChip(500)">500</button>
            </div>
            <button class="bet-btn" id="bet-confirm" onclick="confirmBet()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –°–¢–ê–í–ö–£</button>
        </div>

        <div class="players-list" id="p-list"></div>
    </div>

    <div id="profile-view" class="overlay" style="display: none; background: var(--bg);">
        <img src="https://i.pravatar.cc/150?u=me" id="p-avatar-preview" class="profile-avatar">
        <div class="profile-container">
            <div class="input-group">
                <label>–í–ê–® –ù–ò–ö–ù–ï–ô–ú</label>
                <input type="text" id="p-nick-input" class="profile-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫...">
            </div>
            <div class="input-group">
                <label>URL –ê–í–ê–¢–ê–†–ö–ò</label>
                <input type="text" id="p-avatar-input" class="profile-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ...">
            </div>
            <button onclick="saveProfile()" style="width:100%; padding:15px; background:var(--blue); border:none; border-radius:12px; color:black; font-weight:bold; margin-top:10px;">–°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-arena" onclick="switchTab('arena')">
            <div class="nav-icon">‚ùÑÔ∏è</div>
            <div class="nav-label">Ice Arena</div>
        </div>
        <div class="nav-item" id="nav-profile" onclick="switchTab('profile')">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</div>
        </div>
    </div>
</div>

<script>
    const socket = io(); // –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–†–í–ï–†–£
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    let user = { name: '–ò–≥—Ä–æ–∫', avatar: 'https://i.pravatar.cc/100?u=me' };
    let balance = 1000.0, history = [];
    let selAmt = 0, bank = 0, players = [], state = 'BETTING', timeLeft = 15;
    let ball = { x: 170, y: 170, r: 8, vx: 0, vy: 0, arrowA: 0 };
    let startTime = 0;

    // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
    function saveData() {
        localStorage.setItem('balls_pro_balance', balance);
        localStorage.setItem('balls_pro_history', JSON.stringify(history));
        localStorage.setItem('balls_pro_user', JSON.stringify(user));
    }

    function loadData() {
        const savedBal = localStorage.getItem('balls_pro_balance');
        if (savedBal !== null) balance = parseFloat(savedBal);
        const savedHist = localStorage.getItem('balls_pro_history');
        if (savedHist !== null) history = JSON.parse(savedHist);
        const savedUser = localStorage.getItem('balls_pro_user');
        if (savedUser !== null) user = JSON.parse(savedUser);
        
        document.getElementById('p-nick-input').value = user.name;
        document.getElementById('p-avatar-input').value = user.avatar;
        document.getElementById('p-avatar-preview').src = user.avatar;
        updateUI();
    }

    // –°–ï–¢–ï–í–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø
    socket.on('sync', (gs) => {
        bank = gs.bank;
        players = gs.players.map(p => ({
            ...p,
            avatarImg: p.avatarImg || createAvatar(p.avatar)
        }));
        timeLeft = gs.timeLeft;
        state = gs.status;
        updateUI();
    });

    socket.on('start_game', (data) => {
        state = 'FLYING';
        startTime = Date.now();
        ball.vx = Math.cos(data.angle) * 32;
        ball.vy = Math.sin(data.angle) * 32;
    });

    socket.on('reset', () => {
        resetGameUI();
    });

    function createAvatar(url) {
        const img = new Image();
        img.src = url;
        return img;
    }

    // –¢–ê–ë–´
    function switchTab(tab) {
        if(tab === 'arena') {
            document.getElementById('arena-view').style.display = 'flex';
            document.getElementById('profile-view').style.display = 'none';
            document.getElementById('nav-arena').classList.add('active');
            document.getElementById('nav-profile').classList.remove('active');
        } else {
            document.getElementById('arena-view').style.display = 'none';
            document.getElementById('profile-view').style.display = 'flex';
            document.getElementById('nav-arena').classList.remove('active');
            document.getElementById('nav-profile').classList.add('active');
        }
    }

    function saveProfile() {
        const nick = document.getElementById('p-nick-input').value.trim();
        const ava = document.getElementById('p-avatar-input').value.trim();
        if(nick) user.name = nick;
        if(ava) { user.avatar = ava; document.getElementById('p-avatar-preview').src = ava; }
        saveData();
        switchTab('arena');
    }

    // –ò–ì–†–ê
    function selectChip(amt) {
        if(state !== 'BETTING') return;
        selAmt = amt;
        document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', parseInt(c.innerText) === amt));
    }

    function confirmBet() {
        if(selAmt <= 0 || balance < selAmt || state !== 'BETTING') return;
        
        // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –°–¢–ê–í–ö–£ –ù–ê –°–ï–†–í–ï–†
        socket.emit('bet', {
            name: user.name,
            avatar: user.avatar,
            bet: selAmt,
            color: '#00ffff'
        });

        balance -= selAmt;
        saveData();
        selAmt = 0;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        updateUI();
    }

    function updateUI() {
        document.getElementById('bal-val').innerText = balance.toFixed(1);
        document.getElementById('bank-val').innerText = bank.toFixed(2);
        document.getElementById('timer').innerText = timeLeft;
        const list = document.getElementById('p-list');
        list.innerHTML = '';
        
        players.sort((a,b) => b.bet - a.bet).forEach(p => {
            const chance = bank > 0 ? ((p.bet / bank) * 100).toFixed(1) : 0;
            list.innerHTML += `
                <div class="p-item">
                    <span>
                        <b style="color:${p.color || '#fff'}">‚óè</b> ${p.name}
                        <span class="p-chance">${chance}%</span>
                    </span>
                    <b>${p.bet.toFixed(1)} TON</b>
                </div>`;
        });
        document.getElementById('bet-confirm').disabled = (state !== 'BETTING');
    }

    function finish() {
        if(state === 'END') return;
        state = 'END';
        let angle = Math.atan2(ball.y - 170, ball.x - 170);
        if (angle < 0) angle += Math.PI * 2;
        
        // –ü–æ–∏—Å–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (—Ç–µ–ø–µ—Ä—å –ø–æ –¥–∞–Ω–Ω—ã–º —Å —Å–µ—Ä–≤–µ—Ä–∞)
        let currentA = 0;
        let winner = players[0];
        for(let p of players) {
            let slice = (p.bet / bank) * (Math.PI * 2);
            if(angle >= currentA && angle <= currentA + slice) {
                winner = p;
                break;
            }
            currentA += slice;
        }

        let xMult = (bank / winner.bet).toFixed(2);
        
        if (winner.name === user.name) {
            balance += bank;
            saveData();
        }

        history.unshift({ name: winner.name, avatar: winner.avatar, x: xMult, prize: bank.toFixed(2) });
        if(history.length > 15) history.pop();

        document.getElementById('win-overlay').style.display = 'flex';
        document.getElementById('win-img').src = winner.avatar;
        document.getElementById('win-name').innerText = winner.name;
        document.getElementById('win-sum').innerText = `+${bank.toFixed(2)} TON`;
        document.getElementById('win-x').innerText = `x${xMult}`;
        updateUI();
    }

    function draw() {
        ctx.clearRect(0, 0, 340, 340);
        if (bank > 0) {
            let currentA = 0;
            players.forEach(p => {
                const slice = (p.bet / bank) * (Math.PI * 2);
                ctx.beginPath();
                ctx.moveTo(170, 170);
                ctx.arc(170, 170, 600, currentA, currentA + slice);
                ctx.fillStyle = p.color || '#444';
                ctx.globalAlpha = (p.name === user.name) ? 1.0 : 0.7;
                ctx.fill();
                ctx.globalAlpha = 1.0;
                currentA += slice;
            });
        }

        if (state === 'FLYING') {
            ball.x += ball.vx; ball.y += ball.vy;
            if (ball.x < 10 || ball.x > 330) ball.vx *= -1;
            if (ball.y < 10 || ball.y > 330) ball.vy *= -1;
            ball.vx *= 0.9958; ball.vy *= 0.9958;
            
            ctx.beginPath(); ctx.arc(ball.x, ball.y, 8, 0, Math.PI*2);
            ctx.fillStyle = 'white'; ctx.fill();
            
            if (Date.now() - startTime > 15000 || (Math.abs(ball.vx) < 0.05)) finish();
        } else {
            ctx.beginPath(); ctx.arc(170, 170, 8, 0, Math.PI*2);
            ctx.fillStyle = 'white'; ctx.fill();
        }
        requestAnimationFrame(draw);
    }

    function resetGameUI() {
        document.getElementById('win-overlay').style.display = 'none';
        ball = { x: 170, y: 170, r: 8, vx: 0, vy: 0 };
    }

    function toggleHistory(show) {
        document.getElementById('history-overlay').style.display = show ? 'flex' : 'none';
        if(show) {
            const cont = document.getElementById('hist-content');
            cont.innerHTML = history.map(h => `
                <div class="history-item">
                    <img src="${h.avatar}" class="hist-avatar">
                    <div class="hist-info"><b>${h.name}</b><br><small>+${h.prize} TON</small></div>
                    <div class="hist-x">x${h.x}</div>
                </div>`).join('');
        }
    }

    loadData();
    draw();
</script>
</body>
</html>