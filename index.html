<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balls Pro PvP ONLINE</title>
    <!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú SOCKET.IO (–¥–ª—è –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º–∞) -->
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg: #05050a;
            --blue: #00d2ff;
            --green: #00ff88;
            --surface: #0f0f1b;
            --user-color: #00ffff;
        }

        body {
            margin: 0; background: #000; color: white;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex; justify-content: center; overflow: hidden;
        }

        .app {
            width: 100%; max-width: 400px; height: 100vh;
            background: var(--bg); display: flex; flex-direction: column;
            position: relative;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è (–¢–∞–±—ã) */
        .nav-bar {
            position: absolute; bottom: 0; left: 0; right: 0; height: 70px;
            background: #0a0a15; border-top: 1px solid #1a1a2e;
            display: flex; justify-content: space-around; align-items: center; z-index: 1100;
        }
        .nav-item {
            flex: 1; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer;
            color: #555; transition: 0.2s;
        }
        .nav-item.active { color: var(--blue); border-top: 2px solid var(--blue); }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }
        .nav-label { font-size: 10px; font-weight: bold; text-transform: uppercase; }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–µ —á–∞—Å—Ç–∏ */
        .view { display: none; flex-direction: column; height: 100%; overflow: hidden; padding-bottom: 70px; }
        .view.active { display: flex; }

        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        
        .balance {
            background: rgba(255,255,255,0.05); padding: 8px 16px;
            border-radius: 20px; font-weight: 900; border: 1px solid var(--blue);
            font-size: 16px;
        }

        .jackpot-card {
            margin: 0 15px 10px; padding: 15px; border-radius: 20px;
            background: linear-gradient(135deg, #0a0a25 0%, #05050a 100%);
            border: 1px solid rgba(0, 210, 255, 0.2);
            text-align: center; flex-shrink: 0;
        }
        .jackpot-val { font-size: 32px; font-weight: 900; }

        .game-viewport {
            width: 320px; height: 320px; margin: 0 auto;
            position: relative; border-radius: 35px; 
            overflow: hidden; border: 6px solid #1a1a2e;
            flex-shrink: 0; background: #000;
        }

        .status-line { text-align: center; margin: 10px 0; font-size: 11px; color: var(--blue); letter-spacing: 1px; font-weight: bold;}

        .bet-panel { padding: 10px 15px; flex-shrink: 0; }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .chip {
            background: #111122; border: 2px solid transparent; padding: 12px 0;
            border-radius: 12px; color: white; font-weight: bold; cursor: pointer;
        }
        .chip.active { border-color: var(--blue); background: rgba(0,210,255,0.1); }
        .bet-btn {
            width: 100%; padding: 18px; border-radius: 15px;
            background: var(--green); border: none; color: #000;
            font-weight: 900; font-size: 18px; cursor: pointer;
        }

        /* –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ */
        .players-list { flex-grow: 1; overflow-y: auto; padding: 5px 20px; background: rgba(0,0,0,0.4); }
        .p-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #161625; font-size: 14px; }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile-container { padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--blue); margin-bottom: 20px; object-fit: cover; }
        .uid-tag { background: #1a1a2e; padding: 4px 12px; border-radius: 10px; font-size: 10px; color: #555; margin-bottom: 20px; }
        .input-group { width: 100%; margin-bottom: 20px; }
        .input-group label { display: block; font-size: 12px; color: #888; margin-bottom: 8px; margin-left: 10px;}
        .profile-input {
            width: 100%; background: #111122; border: 1px solid #333;
            padding: 14px; border-radius: 12px; color: white; box-sizing: border-box; font-size: 16px;
        }

        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.96);
            display: none; flex-direction: column; justify-content: center;
            align-items: center; z-index: 1000; text-align: center;
        }
        .w-avatar { width: 90px; height: 90px; border-radius: 50%; border: 4px solid var(--green); margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="app">
    <!-- –ê–†–ï–ù–ê -->
    <div id="view-arena" class="view active">
        <div class="header">
            <div style="font-size: 20px;">‚ùÑÔ∏è</div>
            <div class="balance">üíé <span id="bal-val">100.0</span></div>
        </div>

        <div class="jackpot-card">
            <div style="font-size:11px; color:var(--blue); margin-bottom:4px">JACKPOT</div>
            <div class="jackpot-val"><span id="bank-val">0.00</span> <small style="font-size:14px; opacity:0.5">TON</small></div>
        </div>

        <div class="status-line" id="status-text">–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í...</div>

        <div class="game-viewport">
            <canvas id="gameCanvas" width="320" height="320"></canvas>
            
            <div id="win-overlay" class="overlay">
                <img src="" id="win-img" class="w-avatar">
                <h2 id="win-name" style="margin:0">NAME</h2>
                <h1 id="win-sum" style="color:var(--blue); margin:5px 0">+0.00 TON</h1>
                <div style="background:var(--green); color:#000; padding:4px 12px; border-radius:8px; font-weight:900;" id="win-x">x0.00</div>
                <p style="font-size: 12px; opacity: 0.5; margin-top: 20px;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ...</p>
            </div>
        </div>

        <div class="bet-panel">
            <div class="chips">
                <button class="chip" onclick="selectChip(10)">10</button>
                <button class="chip" onclick="selectChip(50)">50</button>
                <button class="chip" onclick="selectChip(100)">100</button>
                <button class="chip" onclick="selectChip(500)">500</button>
            </div>
            <button class="bet-btn" id="bet-confirm" onclick="confirmBet()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –°–¢–ê–í–ö–£</button>
        </div>

        <div class="players-list" id="p-list"></div>
    </div>

    <!-- –ü–†–û–§–ò–õ–¨ -->
    <div id="view-profile" class="view">
        <div class="profile-container">
            <img src="https://i.pravatar.cc/150?u=me" id="p-preview" class="profile-avatar">
            <div class="uid-tag">UID: <span id="p-uid">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>

            <div class="input-group">
                <label>–í–ê–® –ù–ò–ö–ù–ï–ô–ú</label>
                <input type="text" id="p-nick-input" class="profile-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫...">
            </div>

            <div class="input-group">
                <label>URL –ê–í–ê–¢–ê–†–ö–ò</label>
                <input type="text" id="p-avatar-input" class="profile-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ...">
            </div>

            <button onclick="saveProfile()" class="bet-btn" style="background: var(--blue); color: #000;">–°–û–•–†–ê–ù–ò–¢–¨ –î–ê–ù–ù–´–ï</button>
        </div>
    </div>

    <!-- –¢–ê–ë –ë–ê–† -->
    <div class="nav-bar">
        <div class="nav-item active" id="tab-arena" onclick="switchView('arena')">
            <div class="nav-icon">üèüÔ∏è</div>
            <div class="nav-label">–ê—Ä–µ–Ω–∞</div>
        </div>
        <div class="nav-item" id="tab-profile" onclick="switchView('profile')">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</div>
        </div>
    </div>
</div>

<script>
    const socket = io(); // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É (–≤ —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∞ –±—É–¥–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å –æ—à–∏–±–∫—É, –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–Ω–∏–º–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä)
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    let user = JSON.parse(localStorage.getItem('balls_user')) || {
        uid: 'UID-' + Math.floor(Math.random() * 1000000),
        name: 'Player' + Math.floor(Math.random() * 999),
        avatar: 'https://i.pravatar.cc/150?u=' + Math.random()
    };
    let balance = parseFloat(localStorage.getItem('balls_balance')) || 1000.0;

    // –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´
    let selAmt = 0, bank = 0, players = [], state = 'BETTING', timeLeft = 15;
    let ball = { x: 160, y: 160, r: 8, vx: 0, vy: 0 };
    let timerInt;

    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    function init() {
        localStorage.setItem('balls_user', JSON.stringify(user));
        document.getElementById('p-uid').innerText = user.uid;
        document.getElementById('p-nick-input').value = user.name;
        document.getElementById('p-avatar-input').value = user.avatar;
        document.getElementById('p-preview').src = user.avatar;
        updateUI();
        draw();
    }

    function switchView(view) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        document.getElementById('tab-' + view).classList.add('active');
    }

    function saveProfile() {
        user.name = document.getElementById('p-nick-input').value || user.name;
        user.avatar = document.getElementById('p-avatar-input').value || user.avatar;
        localStorage.setItem('balls_user', JSON.stringify(user));
        document.getElementById('p-preview').src = user.avatar;
        alert('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    }

    // –õ–û–ì–ò–ö–ê –ò–ì–†–´
    function selectChip(amt) {
        if(state !== 'BETTING') return;
        selAmt = amt;
        document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', parseInt(c.innerText) === amt));
    }

    function confirmBet() {
        if(selAmt <= 0 || balance < selAmt || state !== 'BETTING') return;
        
        balance -= selAmt;
        localStorage.setItem('balls_balance', balance);
        
        // –í –û–ù–õ–ê–ô–ù –†–ï–ñ–ò–ú–ï –ú–´ –û–¢–ü–†–ê–í–õ–Ø–ï–ú –≠–¢–û –ù–ê –°–ï–†–í–ï–†:
        // socket.emit('new_bet', { uid: user.uid, name: user.name, avatar: user.avatar, bet: selAmt });
        
        // –°–∏–º—É–ª—è—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∞:
        addPlayer(user.name, selAmt, user.avatar, true);
        
        selAmt = 0;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        updateUI();
        
        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ >= 2
        checkTimerStart();
    }

    function addPlayer(name, amt, avatar, isUser) {
        players.push({ name, bet: amt, avatar, color: isUser ? '#00ffff' : '#ff4444', isUser });
        bank += amt;
        updateUI();
    }

    function checkTimerStart() {
        if(players.length >= 2 && !timerInt) {
            startCountdown();
        }
    }

    function startCountdown() {
        timerInt = setInterval(() => {
            timeLeft--;
            document.getElementById('status-text').innerHTML = `–ù–ê–ß–ê–õ–û –ß–ï–†–ï–ó: ${timeLeft}–°`;
            if(timeLeft <= 0) {
                clearInterval(timerInt);
                launchBall();
            }
        }, 1000);
    }

    function launchBall() {
        state = 'FLYING';
        const randomAngle = Math.random() * Math.PI * 2;
        ball.vx = Math.cos(randomAngle) * 28;
        ball.vy = Math.sin(randomAngle) * 28;
    }

    function updateUI() {
        document.getElementById('bal-val').innerText = balance.toFixed(1);
        document.getElementById('bank-val').innerText = bank.toFixed(2);
        const list = document.getElementById('p-list');
        list.innerHTML = players.map(p => `
            <div class="p-item"><span><b style="color:${p.color}">‚óè</b> ${p.name}</span><b>${p.bet} TON</b></div>
        `).join('');
        
        if(players.length < 2) {
            document.getElementById('status-text').innerText = '–û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í (–ú–ò–ù. 2)...';
        }
    }

    function draw() {
        ctx.clearRect(0, 0, 320, 320);
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ–∫—Ç–æ—Ä–æ–≤
        if (bank > 0) {
            let currentA = 0;
            players.forEach(p => {
                const slice = (p.bet / bank) * (Math.PI * 2);
                ctx.beginPath();
                ctx.moveTo(160, 160);
                ctx.arc(160, 160, 500, currentA, currentA + slice);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = 0.7;
                ctx.fill();
                ctx.globalAlpha = 1.0;
                currentA += slice;
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —à–∞—Ä–∏–∫–∞
        if (state === 'FLYING') {
            ball.x += ball.vx; ball.y += ball.vy;
            // –û—Ç—Å–∫–æ–∫–∏
            if (ball.x < 10 || ball.x > 310) ball.vx *= -1;
            if (ball.y < 10 || ball.y > 310) ball.vy *= -1;
            // –¢—Ä–µ–Ω–∏–µ
            ball.vx *= 0.995; ball.vy *= 0.995;

            ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
            ctx.fillStyle = 'white'; ctx.shadowBlur = 10; ctx.shadowColor = 'white';
            ctx.fill(); ctx.shadowBlur = 0;

            if (Math.abs(ball.vx) < 0.1) finishGame();
        } else {
            ctx.beginPath(); ctx.arc(160, 160, ball.r, 0, Math.PI*2);
            ctx.fillStyle = 'white'; ctx.fill();
        }
        
        requestAnimationFrame(draw);
    }

    function finishGame() {
        state = 'END';
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –ø–æ —É–≥–ª—É —à–∞—Ä–∏–∫–∞
        let angle = Math.atan2(ball.y - 160, ball.x - 160);
        if (angle < 0) angle += Math.PI * 2;
        
        let currentA = 0;
        let winner = players[0];
        players.forEach(p => {
            const slice = (p.bet / bank) * (Math.PI * 2);
            if (angle >= currentA && angle <= currentA + slice) winner = p;
            currentA += slice;
        });

        const xMult = (bank / winner.bet).toFixed(2);
        
        document.getElementById('win-overlay').style.display = 'flex';
        document.getElementById('win-img').src = winner.avatar;
        document.getElementById('win-name').innerText = winner.name;
        document.getElementById('win-sum').innerText = `+${bank.toFixed(2)} TON`;
        document.getElementById('win-x').innerText = `x${xMult}`;

        if(winner.isUser) {
            balance += bank;
            localStorage.setItem('balls_balance', balance);
        }

        // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ó–ê–ö–†–´–¢–ò–ï —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            resetGame();
        }, 5000);
    }

    function resetGame() {
        document.getElementById('win-overlay').style.display = 'none';
        bank = 0; players = []; timeLeft = 15; state = 'BETTING';
        ball = { x: 160, y: 160, r: 8, vx: 0, vy: 0 };
        timerInt = null;
        updateUI();
    }

    init();
</script>
</body>
</html>
