<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ice Arena Online</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --bg: #05050a; --blue: #00d2ff; --green: #00ff88; }
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; display: flex; justify-content: center; }
        .app { width: 100%; max-width: 400px; height: 100vh; background: var(--bg); position: relative; display: flex; flex-direction: column; }
        
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .balance { background: rgba(255,255,255,0.05); padding: 8px 15px; border-radius: 20px; border: 1px solid var(--blue); font-weight: bold; }
        
        .jackpot-card { margin: 0 15px 10px; padding: 15px; background: #0a0a1a; border: 1px solid #1a1a3a; border-radius: 20px; text-align: center; }
        .jackpot-val { font-size: 28px; font-weight: 900; color: #fff; }

        .game-viewport { width: 330px; height: 330px; margin: 0 auto; position: relative; border: 4px solid #1a1a2e; border-radius: 20px; background: #000; overflow: hidden; }
        #gameCanvas { display: block; }

        .status-line { text-align: center; font-size: 12px; color: #555; margin: 5px 0; }
        
        .bet-panel { padding: 10px 15px; }
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .chip { background: #112; border: 2px solid #223; padding: 10px 0; border-radius: 10px; color: #fff; cursor: pointer; font-weight: bold; }
        .chip.active { border-color: var(--blue); background: rgba(0,210,255,0.1); }
        .bet-btn { width: 100%; padding: 15px; border-radius: 12px; background: var(--green); border: none; font-weight: bold; font-size: 16px; }
        .bet-btn:disabled { background: #222; color: #444; }

        .players-list { flex-grow: 1; overflow-y: auto; padding: 10px 20px; background: rgba(0,0,0,0.3); }
        .p-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #112; font-size: 14px; }

        .overlay { position: absolute; inset: 0; background: var(--bg); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .nav-bar { height: 70px; background: #0a0a15; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #1a1a2e; }
        .nav-item { color: #555; font-size: 12px; font-weight: bold; cursor: pointer; text-align: center; }
        .nav-item.active { color: var(--blue); }

        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--blue); margin-bottom: 15px; }
        .profile-input { width: 80%; background: #112; border: 1px solid #333; padding: 12px; border-radius: 10px; color: #fff; margin-bottom: 10px; text-align: center; }
        
        #win-overlay { background: rgba(0,0,0,0.9); z-index: 2000; }
        .w-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--green); margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="app">
    <div id="arena-view" style="display: flex; flex-direction: column; flex-grow: 1;">
        <div class="header">
            <div style="font-size: 20px;">üïí</div>
            <div class="balance">üíé <span id="bal-val">500.0</span></div>
        </div>
        <div class="jackpot-card">
            <div style="font-size:10px; color:var(--blue)">BANK</div>
            <div class="jackpot-val"><span id="bank-val">0.00</span> <small style="font-size:12px;">TON</small></div>
        </div>
        <div class="status-line"><span id="status-txt">WAITING</span>: <span id="timer">15</span>s</div>
        <div class="game-viewport">
            <canvas id="gameCanvas" width="330" height="330"></canvas>
            
            <!-- –û–ö–ù–û –ü–û–ë–ï–î–´ -->
            <div id="win-overlay" class="overlay">
                <img src="" id="win-img" class="w-avatar">
                <h2 id="win-name" style="margin:5px 0">Winner</h2>
                <h1 id="win-sum" style="color:var(--blue); margin:5px 0">+0.00 TON</h1>
                <button onclick="closeWin()" style="margin-top:15px; padding:12px 30px; background:var(--blue); border:none; border-radius:10px; font-weight:bold; color:black; cursor:pointer;">CLOSE</button>
            </div>
        </div>
        <div class="bet-panel">
            <div class="chips">
                <button class="chip" onclick="selectChip(10)">10</button>
                <button class="chip" onclick="selectChip(50)">50</button>
                <button class="chip" onclick="selectChip(100)">100</button>
                <button class="chip" onclick="selectChip(250)">250</button>
            </div>
            <button class="bet-btn" id="bet-confirm" onclick="confirmBet()">PLACE BET</button>
        </div>
        <div class="players-list" id="p-list"></div>
    </div>

    <div id="profile-view" class="overlay">
        <img src="" id="p-preview" class="profile-avatar">
        <div style="font-size: 12px; color: #555; margin-bottom: 10px;">YOUR ID: <span id="p-uid">000000</span></div>
        <input type="text" id="p-name" class="profile-input" placeholder="Nickname">
        <input type="text" id="p-ava" class="profile-input" placeholder="Avatar URL">
        <button onclick="saveProfile()" style="padding:12px 35px; background:var(--green); border:none; border-radius:10px; font-weight:bold;">SAVE</button>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-arena" onclick="switchTab('arena')">ARENA</div>
        <div class="nav-item" id="nav-profile" onclick="switchTab('profile')">PROFILE</div>
    </div>
</div>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // –ê–∫–∫–∞—É–Ω—Ç –∏–≥—Ä–æ–∫–∞
    let user = JSON.parse(localStorage.getItem('balls_user')) || {
        uid: Math.floor(100000 + Math.random() * 900000).toString(),
        name: 'Player' + Math.floor(Math.random()*999),
        avatar: 'https://i.pravatar.cc/100?u=' + Math.random(),
        balance: 500.0
    };

    let bank = 0, players = [], state = 'BETTING', timeLeft = 15, selAmt = 0;
    let ball = { x: 165, y: 165, vx: 0, vy: 0, r: 8 };
    let startTime = 0;
    let images = {}; 
    let winShownInThisRound = false; // –§–ª–∞–≥ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–æ–∫–∞–∑–∞ –æ–∫–Ω–∞ 1 —Ä–∞–∑

    function saveAccount() { localStorage.setItem('balls_user', JSON.stringify(user)); }
    
    function loadProfileInputs() {
        document.getElementById('p-name').value = user.name;
        document.getElementById('p-ava').value = user.avatar;
        document.getElementById('p-preview').src = user.avatar;
        document.getElementById('p-uid').innerText = user.uid;
        document.getElementById('bal-val').innerText = user.balance.toFixed(1);
    }

    // –°–æ–∫–µ—Ç—ã
    socket.on('sync', (gs) => {
        bank = gs.bank; players = gs.players; timeLeft = gs.timeLeft; state = gs.status;
        document.getElementById('status-txt').innerText = state;
        updateUI();
    });

    socket.on('start_game', (data) => {
        closeWin(); // –ê–≤—Ç–æ-–∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        winShownInThisRound = false; 
        state = 'FLYING'; startTime = Date.now();
        ball.x = 165; ball.y = 165;
        ball.vx = Math.cos(data.angle) * 28;
        ball.vy = Math.sin(data.angle) * 28;
    });

    socket.on('reset_game', () => {
        closeWin(); // –ê–≤—Ç–æ-–∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
        state = 'BETTING'; ball.vx = 0; ball.vy = 0; ball.x = 165; ball.y = 165;
        winShownInThisRound = false;
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞
    function closeWin() {
        document.getElementById('win-overlay').style.display = 'none';
    }

    function updateUI() {
        document.getElementById('bank-val').innerText = bank.toFixed(2);
        document.getElementById('timer').innerText = timeLeft;
        document.getElementById('bal-val').innerText = user.balance.toFixed(1);
        const list = document.getElementById('p-list');
        list.innerHTML = players.sort((a,b)=>b.bet-a.bet).map(p => `
            <div class="p-item">
                <span style="color:${p.color}">‚óè ${p.name} <small style="color:#555">(${(p.bet/bank*100).toFixed(1)}%)</small></span>
                <b>${p.bet} TON</b>
            </div>
        `).join('');
        document.getElementById('bet-confirm').disabled = (state !== 'BETTING');
    }

    function selectChip(amt) {
        if(state !== 'BETTING') return;
        selAmt = amt;
        document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', parseInt(c.innerText) === amt));
    }

    function confirmBet() {
        if(selAmt <= 0 || user.balance < selAmt || state !== 'BETTING') return;
        user.balance -= selAmt;
        socket.emit('bet', { uid: user.uid, name: user.name, avatar: user.avatar, bet: selAmt });
        saveAccount();
        selAmt = 0;
        updateUI();
    }

    function saveProfile() {
        user.name = document.getElementById('p-name').value;
        user.avatar = document.getElementById('p-ava').value;
        saveAccount(); loadProfileInputs();
        switchTab('arena');
    }

    function switchTab(tab) {
        const isArena = tab === 'arena';
        document.getElementById('arena-view').style.display = isArena ? 'flex' : 'none';
        document.getElementById('profile-view').style.display = isArena ? 'none' : 'flex';
        document.getElementById('nav-arena').classList.toggle('active', isArena);
        document.getElementById('nav-profile').classList.toggle('active', !isArena);
    }

    function draw() {
        ctx.clearRect(0, 0, 330, 330);
        
        // –°–µ–∫—Ç–æ—Ä–∞
        if (bank > 0) {
            let currentA = 0;
            players.forEach(p => {
                const slice = (p.bet / bank) * (Math.PI * 2);
                ctx.beginPath(); ctx.moveTo(165, 165);
                ctx.arc(165, 165, 500, currentA, currentA + slice);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = 0.8; ctx.fill(); ctx.globalAlpha = 1;

                // –ê–≤–∞—Ç–∞—Ä–∫–∏
                const midA = currentA + slice / 2;
                const ax = 165 + Math.cos(midA) * 110;
                const ay = 165 + Math.sin(midA) * 110;
                
                if(!images[p.avatar]) {
                    images[p.avatar] = new Image();
                    images[p.avatar].src = p.avatar;
                }
                
                ctx.save();
                ctx.beginPath(); ctx.arc(ax, ay, 15, 0, Math.PI*2); ctx.clip();
                if(images[p.avatar].complete) ctx.drawImage(images[p.avatar], ax-15, ay-15, 30, 30);
                ctx.restore();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();

                currentA += slice;
            });
        }

        // –®–∞—Ä–∏–∫
        if (state === 'FLYING') {
            ball.x += ball.vx; ball.y += ball.vy;

            if (ball.x <= ball.r || ball.x >= 330 - ball.r) { ball.vx *= -1; ball.x = ball.x <= ball.r ? ball.r : 330 - ball.r; }
            if (ball.y <= ball.r || ball.y >= 330 - ball.r) { ball.vy *= -1; ball.y = ball.y <= ball.r ? ball.r : 330 - ball.r; }

            ball.vx *= 0.994; ball.vy *= 0.994;

            ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
            ctx.fillStyle = '#fff'; ctx.shadowBlur = 10; ctx.shadowColor = '#fff';
            ctx.fill(); ctx.shadowBlur = 0;

            if (Date.now() - startTime > 10000) showWinner();
        } else {
            ctx.beginPath(); ctx.arc(165, 165, ball.r, 0, Math.PI*2);
            ctx.fillStyle = '#fff'; ctx.fill();
        }
        requestAnimationFrame(draw);
    }

    function showWinner() {
        if(winShownInThisRound || state === 'END') return;
        winShownInThisRound = true;
        state = 'END';
        
        let angle = Math.atan2(ball.y - 165, ball.x - 165);
        if (angle < 0) angle += Math.PI * 2;
        
        let currentA = 0;
        let winner = players[0];
        for(let p of players) {
            let slice = (p.bet / bank) * (Math.PI * 2);
            if(angle >= currentA && angle <= currentA + slice) { winner = p; break; }
            currentA += slice;
        }

        if(winner && winner.uid === user.uid) {
            user.balance += bank;
            saveAccount();
        }

        if(winner) {
            document.getElementById('win-overlay').style.display = 'flex';
            document.getElementById('win-img').src = winner.avatar;
            document.getElementById('win-name').innerText = winner.name;
            document.getElementById('win-sum').innerText = `+${bank.toFixed(2)} TON`;
        }
        updateUI();
    }

    loadProfileInputs();
    draw();
</script>
</body>
</html>
